<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard de Investimentos — BRL Base</title>
  <style>
    :root{
      --bg:#0a0f16;
      --card:#0f1826;
      --card2:#0c1421;
      --text:#eef4ff;
      --muted:#a9bdd8;
      --line:rgba(255,255,255,.10);

      --green:#2bd574;
      --red:#ff5c6c;
      --yellow:#f7b84b;
      --blue:#67b0ff;

      --shadow: 0 18px 52px rgba(0,0,0,.45);
      --shadow2: 0 16px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(103,176,255,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 20%, rgba(43,213,116,.12), transparent 60%),
        radial-gradient(900px 600px at 30% 90%, rgba(255,92,108,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
      font-size:14px;
      line-height:1.45;
    }

    header{
      padding:22px 18px 10px;
      max-width:1180px; margin:0 auto;
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }

    .title h1{margin:0; font-size:22px; letter-spacing:.2px}
    .title p{margin:8px 0 0; color:var(--muted); font-size:14px; line-height:1.4}

    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: 0 12px 26px rgba(0,0,0,.28);
      font-size:13.5px;
      font-weight:600;
      letter-spacing:.1px;
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{border-color:rgba(255,255,255,.20)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border:1px solid rgba(103,176,255,.45);
      background:linear-gradient(180deg, rgba(103,176,255,.26), rgba(103,176,255,.10));
    }
    .btn.danger{
      border:1px solid rgba(255,92,108,.45);
      background:linear-gradient(180deg, rgba(255,92,108,.22), rgba(255,92,108,.09));
    }
    .btn.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,.14);
    }
    .btn.small{
      padding:7px 10px;
      font-size:12.5px;
      border-radius:10px;
      box-shadow:none;
    }

    main{max-width:1180px; margin:0 auto; padding:10px 18px 28px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
    }

    .kpi{grid-column: span 3;}
    @media (max-width: 980px){ .kpi{grid-column: span 6;} }
    @media (max-width: 520px){ .kpi{grid-column: span 12;} }

    .kpi .label{color:var(--muted); font-size:12.5px; font-weight:600}
    .kpi .value{margin-top:10px; font-size:22px; font-weight:800; letter-spacing:.2px}
    .kpi .sub{margin-top:8px; font-size:12.5px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 11px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12.5px;
    }
    .pill strong{color:var(--text); font-family:var(--mono); font-weight:800}

    .tableCard{grid-column: span 12; padding:0}
    .tableHeader{
      padding:14px 14px 12px;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .tableHeader h2{margin:0; font-size:16px; font-weight:800; letter-spacing:.2px}
    .tableHeader .meta{color:var(--muted); font-size:12.5px}

    .tableWrap{overflow:auto}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:1120px}
    th, td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
      font-size:13px;
      white-space:nowrap;
    }
    th{
      color:rgba(255,255,255,.78);
      font-weight:700;
      text-align:left;
      background:rgba(255,255,255,.03);
      position:sticky;
      top:0;
      backdrop-filter: blur(8px);
      z-index:1;
    }
    tr:hover td{background:rgba(255,255,255,.03)}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .pos{color:var(--green); font-weight:800}
    .neg{color:var(--red); font-weight:800}
    .warn{color:var(--yellow); font-weight:800}

    .tag{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.80);
      font-size:12.5px;
      gap:8px;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.25)}
    .dot.green{background:var(--green)}
    .dot.red{background:var(--red)}
    .dot.blue{background:var(--blue)}
    .dot.yellow{background:var(--yellow)}

    .inlineInputs{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    input[type="number"], input[type="text"], input[type="date"]{
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 11px;
      color:var(--text);
      font-size:13.5px;
      outline:none;
      width:180px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.12);
      transition: border-color .12s ease, box-shadow .12s ease;
    }
    input[type="text"]{width:240px}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
    input:focus{
      border-color: rgba(103,176,255,.55);
      box-shadow: 0 0 0 3px rgba(103,176,255,.18);
    }

    .footerNote{
      margin-top:12px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.5;
    }

    .toast{
      position:fixed; bottom:18px; right:18px;
      background:rgba(15,24,38,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px 14px;
      box-shadow:var(--shadow2);
      color:var(--text);
      font-size:13px;
      display:none;
      max-width:360px;
      z-index:50;
    }
    .toast.show{display:block}

    /* HISTÓRICO (GERAL) */
    .historyCard{grid-column: span 12; padding:0}
    .historyGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      padding:14px;
    }
    @media (max-width: 980px){ .historyGrid{grid-template-columns: 1fr;} }
    .canvasWrap{
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius2);
      padding:12px;
      overflow:hidden;
    }
    canvas{width:100%; height:250px; display:block;}

    .miniTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius2);
      overflow:hidden;
    }
    .miniTable th, .miniTable td{
      padding:11px 12px;
      border-bottom:1px solid rgba(255,255,255,.07);
      font-size:13px;
      white-space:nowrap;
    }
    .miniTable th{
      background:rgba(255,255,255,.03);
      color:rgba(255,255,255,.78);
      text-align:left;
      font-weight:700;
    }
    .miniTable tr:last-child td{border-bottom:none;}

    /* MODAL (EDIÇÃO INDIVIDUAL) */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:flex-end;
      justify-content:flex-end;
      z-index:60;
    }
    .modalOverlay.show{display:flex;}
    .drawer{
      width:min(520px, 100vw);
      height:100%;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-left:1px solid rgba(255,255,255,.14);
      box-shadow: -20px 0 60px rgba(0,0,0,.55);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .drawerHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding-bottom:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .drawerHeader h3{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .drawerHeader .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .drawerBody{
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      padding-right:4px;
    }
    .formRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .formRow.one{grid-template-columns:1fr;}
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:12.5px;
      color:rgba(255,255,255,.78);
      font-weight:700;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      line-height:1.35;
    }
    textarea{
      background:rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 11px;
      color:var(--text);
      font-size:13.5px;
      outline:none;
      min-height:84px;
      resize:vertical;
    }
    textarea:focus{
      border-color: rgba(103,176,255,.55);
      box-shadow: 0 0 0 3px rgba(103,176,255,.18);
    }
    .drawerFooter{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,.10);
    }

    /* HISTÓRICO POR ATIVO */
    .assetHistoryCard{grid-column: span 12; padding:0; display:none;}
    .assetHistoryCard.show{display:block;}
    .segmented{
      display:inline-flex;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      overflow:hidden;
    }
    .segmented button{
      border:none;
      background:transparent;
      color:rgba(255,255,255,.82);
      padding:8px 10px;
      font-size:12.5px;
      cursor:pointer;
      font-weight:800;
    }
    .segmented button.active{
      background:rgba(255,255,255,.08);
      color:var(--text);
    }
    .assetHistoryGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      padding:14px;
    }
    @media (max-width: 980px){ .assetHistoryGrid{grid-template-columns:1fr;} }

    .clickableRow{cursor:pointer;}
    .rowActions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      align-items:center;
    }
    .kbd{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.82);
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px;
      padding:6px 8px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>Dashboard de Investimentos (Base BRL)</h1>
    <p>
      Acompanhamento com atualização automática (câmbio, cripto, ações e taxas do BCB).
      <br><span class="muted">Verde = ganho, vermelho = perda. Valores em moeda original e convertido em BRL.</span>
    </p>
  </div>

  <div class="actions">
    <span class="pill">Última atualização: <strong id="lastUpdated">—</strong></span>
    <button class="btn primary" id="refreshBtn">Atualizar agora</button>
    <button class="btn" id="editBtn" title="Modo legado (edição em sequência)">Editar quantidades</button>
    <button class="btn danger" id="resetBtn">Resetar dados</button>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card kpi">
      <div class="label">Patrimônio total (BRL)</div>
      <div class="value mono" id="kpiTotalBRL">—</div>
      <div class="sub" id="kpiTotalSub">—</div>
    </div>

    <div class="card kpi">
      <div class="label">Ganho/Perda estimado (BRL)</div>
      <div class="value mono" id="kpiPnL">—</div>
      <div class="sub muted">Baseado em preço atual vs preço médio (quando informado)</div>
    </div>

    <div class="card kpi">
      <div class="label">Variação 24h (aprox.)</div>
      <div class="value mono" id="kpi24h">—</div>
      <div class="sub muted">Para ativos com fonte de cotação (BTC e ações B3 / iShares)</div>
    </div>

    <div class="card kpi">
      <div class="label">Mercado (para cálculo)</div>
      <div class="value" style="display:flex; gap:10px; flex-wrap:wrap;">
        <span class="tag"><span class="dot blue"></span><span>USD/BRL</span> <span class="mono" id="fxUSDBRL">—</span></span>
        <span class="tag"><span class="dot yellow"></span><span>EUR/BRL</span> <span class="mono" id="fxEURBRL">—</span></span>
      </div>
      <div class="sub muted" id="ratesMeta">SELIC/CDI: —</div>
    </div>

    <div class="card tableCard">
      <div class="tableHeader">
        <div>
          <h2>Carteira — visão consolidada</h2>
          <div class="meta" id="metaInfo">—</div>
          <div class="meta" style="margin-top:6px;">
            <span class="kbd">Dica</span>
            Clique em uma linha para abrir o <b>Histórico do ativo</b> • ou use <b>Editar</b> para ajustar o investimento.
          </div>
        </div>
        <div class="inlineInputs">
          <input type="text" id="filterInput" placeholder="Filtrar (ex: VALE3, BTC, Nubank)" />
          <button class="btn" id="exportBtn">Exportar JSON</button>
          <button class="btn" id="importBtn">Importar JSON</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ativo</th>
              <th>Categoria</th>
              <th>Conta</th>
              <th class="right">Quantidade / Saldo</th>
              <th class="right">Preço atual</th>
              <th class="right">Valor (moeda)</th>
              <th class="right">Valor (BRL)</th>
              <th class="right">Líquido (BRL)</th>
              <th class="right">Impostos (BRL)</th>
              <th class="right">G/P (BRL)</th>
              <th class="right">24h</th>
              <th>Status</th>
              <th class="right">Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="tableHeader" style="border-top:1px solid rgba(255,255,255,.08); border-bottom:none;">
        <div class="footerNote">
          <b>Notas rápidas</b><br/>
          1) Renda fixa por “lotes” calcula <b>bruto + líquido</b> (IOF &lt; 30 dias + IR regressivo por prazo) como se resgatasse hoje.<br/>
          2) SELIC/CDI vêm do BCB (SGS) e a capitalização usa a <b>série diária</b> para respeitar histórico do período do aporte.<br/>
          3) Ferramenta de acompanhamento, não é recomendação.
        </div>
      </div>
    </div>

    <!-- HISTÓRICO GERAL (PORTFÓLIO) -->
    <div class="card historyCard" id="portfolioHistoryCard">
      <div class="tableHeader">
        <div>
          <h2>Histórico — evolução da carteira</h2>
          <div class="meta">Salve snapshots mensais (ex.: desde 2021) e acompanhe crescimento com gráfico e variações.</div>
        </div>
        <div class="inlineInputs">
          <div class="segmented" aria-label="Modo de histórico">
            <button class="active" id="modePortfolioBtn" type="button">Carteira</button>
            <button id="modeAssetBtn" type="button">Ativo</button>
          </div>
          <input type="date" id="snapDate" />
          <input type="text" id="snapNote" placeholder="Nota (opcional)" />
          <button class="btn primary" id="saveSnapshotBtn">Salvar snapshot</button>
          <button class="btn" id="manageHistoryBtn">Gerenciar</button>
          <button class="btn danger" id="deleteLastSnapshotBtn">Apagar último</button>
        </div>
      </div>

      <div class="historyGrid">
        <div class="canvasWrap">
          <canvas id="historyChart" width="1000" height="320"></canvas>
          <div class="footerNote" id="historySummary">—</div>
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
          <table class="miniTable">
            <thead>
              <tr>
                <th>Mês/Data</th>
                <th class="right">Total (BRL)</th>
                <th class="right">Δ (R$)</th>
                <th class="right">Δ (%)</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
          <div class="footerNote muted">
            Dica: faça um snapshot no fim de cada mês. Para histórico antigo (2021/2022…), você pode adicionar valores manualmente no “Gerenciar”.
          </div>
        </div>
      </div>
    </div>

    <!-- HISTÓRICO POR ATIVO -->
    <div class="card assetHistoryCard" id="assetHistoryCard">
      <div class="tableHeader">
        <div>
          <h2 id="assetHistoryTitle">Histórico — ativo</h2>
          <div class="meta" id="assetHistoryMeta">Selecione um ativo na tabela para visualizar e editar o histórico.</div>
        </div>
        <div class="inlineInputs">
          <div class="segmented" aria-label="Modo de histórico">
            <button id="modePortfolioBtn2" type="button">Carteira</button>
            <button class="active" id="modeAssetBtn2" type="button">Ativo</button>
          </div>
          <button class="btn" id="assetBackBtn">Voltar para carteira</button>
          <input type="date" id="assetSnapDate" />
          <input type="number" id="assetSnapValue" placeholder="Total do ativo (moeda)" />
          <input type="text" id="assetSnapNote" placeholder="Nota (opcional)" />
          <button class="btn primary" id="saveAssetSnapshotBtn">Salvar no ativo</button>
          <button class="btn" id="manageAssetHistoryBtn">Gerenciar</button>
          <button class="btn danger" id="deleteLastAssetSnapshotBtn">Apagar último</button>
        </div>
      </div>

      <div class="assetHistoryGrid">
        <div class="canvasWrap">
          <canvas id="assetHistoryChart" width="1000" height="320"></canvas>
          <div class="footerNote" id="assetHistorySummary">—</div>
        </div>

        <div style="display:flex; flex-direction:column; gap:12px;">
          <table class="miniTable">
            <thead>
              <tr>
                <th>Mês/Data</th>
                <th class="right">Total (moeda)</th>
                <th class="right">Δ</th>
                <th class="right">Δ (%)</th>
              </tr>
            </thead>
            <tbody id="assetHistoryTbody"></tbody>
          </table>
          <div class="footerNote muted">
            Dica: o histórico por ativo é salvo separadamente. Útil para acompanhar “aportes” e evolução por investimento.
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<!-- Drawer / Modal de edição -->
<div class="modalOverlay" id="assetEditOverlay" role="dialog" aria-modal="true" aria-label="Editar investimento">
  <div class="drawer" role="document">
    <div class="drawerHeader">
      <div>
        <h3 id="editTitle">Editar investimento</h3>
        <div class="sub" id="editSub">—</div>
      </div>
      <button class="btn ghost small" id="closeEditBtn" title="Fechar">Fechar</button>
    </div>

    <div class="drawerBody">
      <div class="formRow" id="qtyRow">
        <div class="field">
          <label id="editQtyLabel" for="editQty">Quantidade</label>
          <input type="number" id="editQty" step="any" />
          <div class="hint" id="editQtyHint">—</div>
        </div>

        <div class="field">
          <label for="editAvgCost">Preço médio (opcional)</label>
          <input type="number" id="editAvgCost" step="any" placeholder="Ex.: 24.50" />
          <div class="hint">Se vazio, o painel ignora o cálculo de G/P.</div>
        </div>
      </div>

      <div class="formRow one" id="lotsRow" style="display:none;">
        <div class="field">
          <label for="editLots">Aportes (um por linha)</label>
          <textarea id="editLots" placeholder="YYYY-MM-DD | 1000.00&#10;2026-09-01 | 500.00"></textarea>
          <div class="hint">Use ponto no decimal. O sistema calcula bruto e líquido (IOF/IR) como se resgatasse hoje.</div>
        </div>
      </div>

      <div class="formRow" id="manualPriceRow" style="display:none;">
        <div class="field">
          <label for="editManualPrice">Preço manual (por cota/unidade)</label>
          <input type="number" id="editManualPrice" step="any" />
          <div class="hint">Usado apenas para ativos com preço manual.</div>
        </div>
        <div class="field">
          <label for="editNotesShort">Resumo</label>
          <input type="text" id="editNotesShort" placeholder="Ex.: Aporte mensal / Longo prazo" />
          <div class="hint">Opcional. Você também pode detalhar abaixo.</div>
        </div>
      </div>

      <div class="formRow one">
        <div class="field">
          <label for="editNotes">Notas</label>
          <textarea id="editNotes" placeholder="Escreva detalhes do investimento (opcional)"></textarea>
        </div>
      </div>
    </div>

    <div class="drawerFooter">
      <button class="btn" id="cancelEditBtn">Cancelar</button>
      <button class="btn primary" id="saveEditBtn">Salvar</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Config / Fontes
   - FX: Frankfurter (ECB)
   - BTC: CoinGecko
   - Ações B3: brapi.dev (pode exigir token)
   - SELIC/CDI: BCB SGS (séries diárias)
   - iShares World: iShares page (NAV/1d NAV change) com fallback via r.jina.ai
   ========================= */

const STORAGE_KEY = "inv_dashboard_v1";

// compat: alguns navegadores não suportam structuredClone
const deepClone = (obj) => {
  if (typeof structuredClone === "function") return structuredClone(obj);
  return JSON.parse(JSON.stringify(obj));
};

/* =========================
   Dados padrão
   ========================= */

const DEFAULT_DATA = {
  settings: {
    baseCurrency: "BRL",
    autoRefreshMinutes: 30,
    brapiToken: "" // opcional: token do brapi.dev (se necessário)
  },
  assets: [
    { id:"btc", name:"Bitcoin", category:"Cripto", account:"BINANCE", currency:"USD", mode:"crypto", coingeckoId:"bitcoin", qty:0.0, avgCost:null, notes:"Qtd em BTC; preço em USD" },

    { id:"td_selic_2026", name:"Tesouro Selic 2026", category:"Renda fixa", account:"C6", currency:"BRL",
      mode:"rf_selic", lots:[], avgCost:null, notes:"Aportes com datas. Base: SELIC diária (BCB)." },

    { id:"td_selic_2027", name:"Tesouro Selic 2027", category:"Renda fixa", account:"C6", currency:"BRL",
      mode:"rf_selic", lots:[], avgCost:null, notes:"Aportes com datas. Base: SELIC diária (BCB)." },

    { id:"td_selic_2029", name:"Tesouro Selic 2029", category:"Renda fixa", account:"C6", currency:"BRL",
      mode:"rf_selic", lots:[], avgCost:null, notes:"Aportes com datas. Base: SELIC diária (BCB)." },

    { id:"nubank_caixinha", name:"Caixinha Nubank (120% CDI)", category:"Renda fixa", account:"NUBANK", currency:"BRL",
      mode:"rf_cdi", cdiMult: 1.20, lots:[], notes:"Aportes com datas. Base: CDI diária (BCB) × 120%." },

    { id:"nu_reserva", name:"Nu Reserva Imediata", category:"Fundo", account:"NUBANK", currency:"BRL",
      mode:"rf_cdi_proxy_fund", cdiMult: 1.00, adminFeeAnnual: 0.003, lots:[], qty:0.0, avgCost:null,
      notes:"Proxy CDI (estimativa) com taxa adm. 0,30% a.a. Se não usar lotes, saldo fica manual." },

    { id:"mp_cofrinho", name:"Cofrinho Mercado Pago (120% CDI)", category:"Renda fixa", account:"Mercado Pago", currency:"BRL",
      mode:"rf_cdi", cdiMult: 1.20, lots:[], notes:"Aportes com datas. Base: CDI diária (BCB) × 120%." },

    { id:"ggbr4", name:"Gerdau", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"GGBR4", qty:0.0, avgCost:null, notes:"Qtd de ações" },
    { id:"vale3", name:"Vale", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"VALE3", qty:0.0, avgCost:null, notes:"Qtd de ações" },
    { id:"cmig4", name:"Cemig", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"CMIG4", qty:0.0, avgCost:null, notes:"Qtd de ações" },
    { id:"tasa4", name:"Taurus", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"TASA4", qty:0.0, avgCost:null, notes:"Qtd de ações" },

    { id:"wise_ishares_world", name:"iShares World Equity Index Fund (A2 USD)", category:"Fundo", account:"WISE", currency:"USD",
      mode:"fund_ishares_auto", qty:0.0, avgCost:null,
      isharesUrl:"https://www.ishares.com/ch/individual/en/products/243974/blackrock-world-equity-index-a2-usd-fund",
      notes:"Preço automático via NAV (iShares). Qtd = cotas/unidades." }
  ],
  manualPrices: {},
  history: [],
  assetHistory: {}
};

let state = loadState();

let market = {
  fx: { USDBRL: null, EURBRL: null },
  quotes: {},
  br: {
    selic: null,
    cdi: null,
    selicAnnualApprox: null,
    cdiAnnualApprox: null,
    histStartISO: null,
    histEndISO: null
  },
  lastUpdated: null,
  errors: []
};

const el = (id) => document.getElementById(id);

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return deepClone(DEFAULT_DATA);

  try{
    const parsed = JSON.parse(raw);

    // remove “dólar em conta” caso exista em dados antigos
    const assets = Array.isArray(parsed.assets) ? parsed.assets.filter(a => a.id !== "usd_cash") : undefined;

    return {
      ...deepClone(DEFAULT_DATA),
      ...parsed,
      assets: assets ?? deepClone(DEFAULT_DATA.assets),
      settings: { ...DEFAULT_DATA.settings, ...(parsed.settings||{}) },
      manualPrices: { ...DEFAULT_DATA.manualPrices, ...(parsed.manualPrices||{}) },
      history: Array.isArray(parsed.history) ? parsed.history : [],
      assetHistory: (parsed.assetHistory && typeof parsed.assetHistory==="object") ? parsed.assetHistory : {}
    };
  }catch{
    return deepClone(DEFAULT_DATA);
  }
}

/* =========================
   Formatting
   ========================= */
function fmtMoney(v, cur="BRL"){
  if(v === null || v === undefined || Number.isNaN(v)) return "—";
  return new Intl.NumberFormat("pt-BR", { style:"currency", currency:cur, maximumFractionDigits: 2 }).format(v);
}
function fmtNum(v, max=6){
  if(v === null || v === undefined || Number.isNaN(v)) return "—";
  return new Intl.NumberFormat("pt-BR", { maximumFractionDigits: max }).format(v);
}
function fmtPct(v){
  if(v === null || v === undefined || Number.isNaN(v)) return "—";
  const sign = v > 0 ? "+" : "";
  return sign + v.toFixed(2) + "%";
}
function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2800);
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =========================
   Tax Engine (IOF/IR)
   ========================= */

// IOF regressivo (% do RENDIMENTO) dias 1..30
const IOF_REGRESSIVE = [
  0,
  0.96,0.93,0.90,0.86,0.83,0.80,0.76,0.73,0.70,
  0.66,0.63,0.60,0.56,0.53,0.50,0.46,0.43,0.40,
  0.36,0.33,0.30,0.26,0.23,0.20,0.16,0.13,0.10,
  0.06,0.03
];
function iofRateForDays(days){
  if(days <= 0) return 0;
  if(days >= 30) return 0;
  return IOF_REGRESSIVE[Math.min(30, days)] || 0;
}

// IR regressivo padrão (renda fixa / fundos longo prazo)
const IR_DEFAULT_TIERS = [
  { maxDays: 180, rate: 0.225 },
  { maxDays: 360, rate: 0.20 },
  { maxDays: 720, rate: 0.175 },
  { maxDays: Infinity, rate: 0.15 }
];
function irRateForDays(days, tiers = IR_DEFAULT_TIERS){
  const d = Math.max(0, Number(days||0));
  for(const t of tiers){
    if(d <= t.maxDays) return t.rate;
  }
  return 0.15;
}

function normalizeDate(yyyy_mm_dd){
  if(!yyyy_mm_dd) return null;
  const s = String(yyyy_mm_dd).trim();
  if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
  return s;
}

function daysBetweenISO(dateISO, now = new Date()){
  const d = new Date(dateISO + "T00:00:00");
  const ms = now.getTime() - d.getTime();
  return Math.max(0, Math.floor(ms / (24*60*60*1000)));
}

function isoToBR(iso){
  const d = normalizeDate(iso);
  if(!d) return null;
  const [y,m,dd] = d.split("-");
  return `${dd}/${m}/${y}`;
}

/* =========================
   FX / Quotes Fetchers
   ========================= */

async function fetchFX(){
  const url = "https://api.frankfurter.app/latest?from=EUR&to=BRL,USD";
  const r = await fetch(url, { cache: "no-store" });
  if(!r.ok) throw new Error("Frankfurter falhou ("+r.status+")");
  const j = await r.json();

  const eurbrl = Number(j?.rates?.BRL);
  const eurusd = Number(j?.rates?.USD);

  market.fx.EURBRL = Number.isFinite(eurbrl) ? eurbrl : null;
  market.fx.USDBRL =
    (Number.isFinite(eurbrl) && Number.isFinite(eurusd) && eurusd !== 0)
      ? (eurbrl / eurusd)
      : null;
}

async function fetchCrypto(){
  const ids = state.assets.filter(x=>x.mode==="crypto").map(x=>x.coingeckoId).filter(Boolean);
  if(ids.length===0) return;

  const url = "https://api.coingecko.com/api/v3/simple/price?ids=" + encodeURIComponent(ids.join(",")) +
              "&vs_currencies=usd&include_24hr_change=true";
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("CoinGecko falhou ("+r.status+")");
  const data = await r.json();

  for(const a of state.assets.filter(x=>x.mode==="crypto")){
    const d = data[a.coingeckoId];
    if(!d) continue;
    market.quotes[a.id] = {
      price: d.usd ?? null,
      changePct24h: d.usd_24h_change ?? null,
      currency: "USD"
    };
  }
}

async function fetchB3Quotes(){
  const syms = state.assets.filter(x=>x.mode==="stock_b3").map(x=>x.symbol).filter(Boolean);
  if(syms.length===0) return;

  const token = String(state.settings?.brapiToken || "").trim();
  const urlFor = (sym) => {
    const base = `https://brapi.dev/api/quote/${encodeURIComponent(sym)}`;
    return token ? `${base}?token=${encodeURIComponent(token)}` : base;
  };

  const tasks = syms.map(sym =>
    fetch(urlFor(sym), { cache:"no-store" })
      .then(async r=>{
        if(!r.ok){
          const text = await r.text().catch(()=> "");
          throw new Error(`B3 ${sym} HTTP ${r.status} ${text.slice(0,120)}`);
        }
        return r.json();
      })
      .then(j=>({sym,j}))
  );

  const res = await Promise.allSettled(tasks);

  res.forEach((item, idx)=>{
    const sym = syms[idx];
    if(item.status!=="fulfilled"){
      market.errors.push(String(item.reason?.message || `B3 ${sym} falhou`));
      return;
    }

    const q = item.value.j?.results?.[0];
    if(!q){
      market.errors.push(`B3 ${sym} sem results`);
      return;
    }

    const price = q.regularMarketPrice ?? null;
    const chg = q.regularMarketChangePercent ?? null;

    const asset = state.assets.find(a=>a.mode==="stock_b3" && a.symbol===sym);
    if(!asset) return;

    market.quotes[asset.id] = { price, changePct24h: chg, currency: "BRL" };
  });
}

/* =========================
   BCB (SGS) - Séries diárias SELIC/CDI com histórico
   Série 11 = SELIC diária (% a.d.)
   Série 12 = CDI diária (% a.d.)
   ========================= */

async function fetchBCBSeriesRange(seriesCode, startISO, endISO){
  const startBR = isoToBR(startISO);
  const endBR = isoToBR(endISO);
  if(!startBR || !endBR) return [];

  const url = `https://api.bcb.gov.br/dados/serie/bcdata.sgs.${seriesCode}/dados?formato=json&dataInicial=${encodeURIComponent(startBR)}&dataFinal=${encodeURIComponent(endBR)}`;
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("BCB SGS falhou ("+r.status+")");
  const j = await r.json();
  return Array.isArray(j) ? j : [];
}

function brDateToISO(d){
  const [dd,mm,yyyy] = String(d||"").split("/");
  if(!dd||!mm||!yyyy) return null;
  return `${yyyy}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`;
}

function buildDailySeries(rows){
  const tmp = [];
  for(const x of rows){
    const iso = brDateToISO(x.data);
    const vPct = Number(String(x.valor||"").replace(",", "."));
    if(!iso || !Number.isFinite(vPct)) continue;
    const rate = vPct / 100; // % a.d. -> decimal ao dia
    tmp.push({ iso, rate });
  }
  tmp.sort((a,b)=>a.iso.localeCompare(b.iso));

  const dates = tmp.map(x=>x.iso);
  const rates = tmp.map(x=>x.rate);
  return { dates, rates };
}

function annualizeFromDaily(daily, basis=252){
  if(!Number.isFinite(daily)) return null;
  return Math.pow(1 + daily, basis) - 1;
}

function getMinLotDateISO(){
  let min = null;
  for(const a of state.assets){
    const lots = Array.isArray(a.lots) ? a.lots : [];
    for(const lot of lots){
      const d = normalizeDate(lot.date);
      if(!d) continue;
      if(min===null || d < min) min = d;
    }
  }
  return min;
}

async function fetchBRRatesAndHistory(){
  const todayISO = new Date().toISOString().slice(0,10);

  let startISO = getMinLotDateISO();
  if(!startISO){
    const d = new Date();
    d.setDate(d.getDate() - 370);
    startISO = d.toISOString().slice(0,10);
  }

  if(market.br.histStartISO === startISO && market.br.histEndISO === todayISO && market.br.selic && market.br.cdi){
    return;
  }

  const [selicRows, cdiRows] = await Promise.all([
    fetchBCBSeriesRange(11, startISO, todayISO),
    fetchBCBSeriesRange(12, startISO, todayISO)
  ]);

  const selic = buildDailySeries(selicRows);
  const cdi   = buildDailySeries(cdiRows);

  market.br.selic = selic;
  market.br.cdi = cdi;

  const lastSelicDaily = selic.rates.length ? selic.rates[selic.rates.length-1] : null;
  const lastCdiDaily = cdi.rates.length ? cdi.rates[cdi.rates.length-1] : null;

  market.br.selicAnnualApprox = (lastSelicDaily===null) ? null : annualizeFromDaily(lastSelicDaily, 252);
  market.br.cdiAnnualApprox   = (lastCdiDaily===null)   ? null : annualizeFromDaily(lastCdiDaily, 252);

  market.br.histStartISO = startISO;
  market.br.histEndISO = todayISO;
}

// busca binária
function lowerBound(arr, target){
  let lo=0, hi=arr.length;
  while(lo<hi){
    const mid=(lo+hi)>>1;
    if(arr[mid] < target) lo=mid+1;
    else hi=mid;
  }
  return lo;
}
function upperBound(arr, target){
  let lo=0, hi=arr.length;
  while(lo<hi){
    const mid=(lo+hi)>>1;
    if(arr[mid] <= target) lo=mid+1;
    else hi=mid;
  }
  return lo;
}

function compoundFromDailySeries(principal, series, startISO, endISO, mult=1.0, feeAnnual=0){
  if(!series || !series.dates?.length) return null;
  const s = normalizeDate(startISO);
  const e = normalizeDate(endISO);
  if(!s || !e) return null;

  const startIdx = lowerBound(series.dates, s);
  const endIdx = upperBound(series.dates, e) - 1;
  if(endIdx < startIdx) return principal;

  const feeDaily = feeAnnual > 0 ? (feeAnnual / 252) : 0;
  let val = principal;

  for(let i=startIdx; i<=endIdx; i++){
    let daily = series.rates[i] * mult;
    if(feeDaily>0) daily = daily - feeDaily;
    if(daily < -0.999) daily = -0.999;
    val = val * (1 + daily);
  }
  return val;
}

/* =========================
   iShares World - NAV automático
   ========================= */

async function fetchTextNoStore(url){
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("Fetch falhou: " + r.status);
  return await r.text();
}

async function fetchTextWithFallback(url){
  try{
    return await fetchTextNoStore(url);
  }catch(e){
    const clean = url.replace(/^https?:\/\//, "");
    const proxy = "https://r.jina.ai/https://" + clean;
    const r = await fetch(proxy, { cache:"no-store" });
    if(!r.ok) throw e;
    return await r.text();
  }
}

function parseIsharesFromText(t){
  const navMatch = t.match(/NAV\s*([\d.,]+)\s*USD/i);
  const chgMatch = t.match(/1\s*Day\s*NAV\s*Change\s*([+\-]?\d+(?:\.\d+)?)\s*%/i);
  const asOfMatch = t.match(/As\s*Of\s*([A-Za-z]+\s+\d{2},\s+\d{4})/i);

  const nav = navMatch ? Number(navMatch[1].replace(",", "")) : null;
  const chg = chgMatch ? Number(chgMatch[1]) : null;
  const asOf = asOfMatch ? asOfMatch[1] : null;

  return { navUSD: Number.isFinite(nav) ? nav : null, changePct: Number.isFinite(chg) ? chg : null, asOf };
}

async function fetchIsharesWorld(){
  const funds = state.assets.filter(a=>a.mode==="fund_ishares_auto" && a.isharesUrl);
  if(!funds.length) return;

  for(const a of funds){
    try{
      const txt = await fetchTextWithFallback(a.isharesUrl);
      const p = parseIsharesFromText(txt);
      if(p.navUSD !== null){
        market.quotes[a.id] = { price: p.navUSD, changePct24h: p.changePct ?? null, currency:"USD" };
      }else{
        market.quotes[a.id] = market.quotes[a.id] || { price:null, changePct24h:null, currency:"USD" };
      }
    }catch(e){
      market.quotes[a.id] = market.quotes[a.id] || { price:null, changePct24h:null, currency:"USD" };
      market.errors.push("iShares indisponível");
    }
  }
}

/* =========================
   FX utils
   ========================= */
function getFXToBRL(currency){
  if(currency==="BRL") return 1.0;
  if(currency==="USD") return market.fx.USDBRL;
  if(currency==="EUR") return market.fx.EURBRL;
  return null;
}

/* =========================
   Cálculos por ativo
   ========================= */

function computeFixedIncomeFromLots(asset){
  const now = new Date();
  const todayISO = now.toISOString().slice(0,10);

  const lots = Array.isArray(asset.lots) ? asset.lots : [];
  if(lots.length === 0) return { grossNative: null, netNative: null, taxesNative: null };

  const isSelic = asset.mode === "rf_selic";
  const isCdi = (asset.mode === "rf_cdi" || asset.mode === "rf_cdi_proxy_fund");

  const series = isSelic ? market.br.selic : (isCdi ? market.br.cdi : null);
  if(!series || !series.dates?.length) return { grossNative: null, netNative: null, taxesNative: null };

  const mult = isSelic ? 1.0 : Number(asset.cdiMult || 1.0);
  const feeAnnual = Number(asset.adminFeeAnnual || 0);

  let gross = 0, net = 0, taxes = 0;

  for(const lot of lots){
    const d = normalizeDate(lot.date);
    const principal = Number(String(lot.amount||0).replace(",", "."));
    if(!d || !Number.isFinite(principal) || principal <= 0) continue;

    const days = daysBetweenISO(d, now);

    const grossLot = compoundFromDailySeries(principal, series, d, todayISO, mult, feeAnnual);
    if(grossLot === null) continue;

    const earnings = Math.max(0, grossLot - principal);

    const iofRate = iofRateForDays(days);
    const iof = earnings * iofRate;

    const earningsAfterIOF = Math.max(0, earnings - iof);
    const ir = earningsAfterIOF * irRateForDays(days, IR_DEFAULT_TIERS);

    const netLot = principal + (earningsAfterIOF - ir);

    gross += grossLot;
    net   += netLot;
    taxes += (iof + ir);
  }

  return { grossNative: gross, netNative: net, taxesNative: taxes };
}

function computeRow(asset){
  if(asset.mode === "rf_selic" || asset.mode === "rf_cdi" || asset.mode === "rf_cdi_proxy_fund"){
    const r = computeFixedIncomeFromLots(asset);

    // fallback: se não há lotes, permite manter saldo manual (qty) (especialmente no Nu Reserva)
    if(r.grossNative === null){
      if(asset.mode === "rf_cdi_proxy_fund" && Number(asset.qty||0) > 0){
        const valueNative = Number(asset.qty||0);
        const fx = getFXToBRL(asset.currency);
        const valueBRL = (fx===null) ? null : valueNative * fx;
        return {
          price:null, change:null,
          valueNative, valueNativeNet:null,
          valueBRL, valueBRLNet:null,
          taxesBRL:null, pnlBRL:null, fx
        };
      }
      return { price:null, change:null, valueNative:null, valueNativeNet:null, valueBRL:null, valueBRLNet:null, taxesBRL:null, pnlBRL:null, fx:getFXToBRL(asset.currency) };
    }

    const fx = getFXToBRL(asset.currency);
    const valueBRL = (fx===null) ? null : r.grossNative * fx;
    const valueBRLNet = (fx===null) ? null : r.netNative * fx;
    const taxesBRL = (fx===null) ? null : r.taxesNative * fx;

    return {
      price:null, change:null,
      valueNative: r.grossNative,
      valueNativeNet: r.netNative,
      valueBRL,
      valueBRLNet,
      taxesBRL,
      pnlBRL:null,
      fx
    };
  }

  let price = null;
  let change = null;

  if(asset.mode==="crypto" || asset.mode==="stock_b3" || asset.mode==="fund_ishares_auto"){
    price = market.quotes[asset.id]?.price ?? null;
    change = market.quotes[asset.id]?.changePct24h ?? null;
  }else if(asset.mode==="fund_manual"){
    price = state.manualPrices?.[asset.id]?.price ?? null;
  }else if(asset.mode==="manual_balance"){
    price = 1.0;
  }

  let valueNative = null;
  if(asset.mode==="manual_balance"){
    valueNative = Number(asset.qty || 0);
  }else{
    const q = Number(asset.qty || 0);
    valueNative = (price===null ? null : q*price);
  }

  const fx = getFXToBRL(asset.currency);
  const valueBRL = (valueNative===null || fx===null) ? null : valueNative*fx;

  let pnlBRL = null;
  if(asset.avgCost !== null && asset.avgCost !== undefined && asset.avgCost !== "" && asset.mode!=="manual_balance"){
    const q = Number(asset.qty || 0);
    const avg = Number(asset.avgCost);
    if(Number.isFinite(q) && Number.isFinite(avg) && price !== null && fx !== null){
      const pnlNative = (price - avg) * q;
      pnlBRL = pnlNative * fx;
    }
  }

  return { price, change, valueNative, valueNativeNet:null, valueBRL, valueBRLNet:null, taxesBRL:null, pnlBRL, fx };
}

function computeTotalBRL(){
  let total = 0;
  for(const a of state.assets){
    const c = computeRow(a);
    if(c.valueBRL !== null) total += c.valueBRL;
  }
  return total;
}

/* =========================
   HISTÓRICO (GERAL)
   ========================= */
function sortHistory(){
  state.history.sort((x,y)=> (x.date||"").localeCompare(y.date||""));
}
function upsertSnapshot(date, totalBRL, note=""){
  const d = normalizeDate(date);
  if(!d) { toast("Data inválida."); return false; }
  if(!Number.isFinite(totalBRL)) { toast("Valor inválido."); return false; }

  const idx = state.history.findIndex(h=>h.date===d);
  const snap = { date:d, totalBRL:Number(totalBRL), note:String(note||"").trim() };

  if(idx>=0) state.history[idx] = snap;
  else state.history.push(snap);

  sortHistory();
  saveState();
  return true;
}
function deleteLastSnapshot(){
  if(state.history.length===0) return;
  sortHistory();
  state.history.pop();
  saveState();
}

/* =========================
   HISTÓRICO POR ATIVO
   ========================= */
function getAssetHistoryList(assetId){
  if(!state.assetHistory) state.assetHistory = {};
  const arr = state.assetHistory[assetId];
  return Array.isArray(arr) ? arr : [];
}
function setAssetHistoryList(assetId, list){
  if(!state.assetHistory) state.assetHistory = {};
  state.assetHistory[assetId] = list;
}
function sortAssetHistory(assetId){
  const h = getAssetHistoryList(assetId);
  h.sort((x,y)=> (x.date||"").localeCompare(y.date||""));
  setAssetHistoryList(assetId, h);
}
function upsertAssetSnapshot(assetId, date, totalNative, note=""){
  const d = normalizeDate(date);
  if(!d) { toast("Data inválida."); return false; }
  if(!Number.isFinite(totalNative)) { toast("Valor inválido."); return false; }

  const h = getAssetHistoryList(assetId);
  const idx = h.findIndex(x=>x.date===d);
  const snap = { date:d, totalNative:Number(totalNative), note:String(note||"").trim() };

  if(idx>=0) h[idx] = snap;
  else h.push(snap);

  h.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  setAssetHistoryList(assetId, h);
  saveState();
  return true;
}
function deleteLastAssetSnapshot(assetId){
  const h = getAssetHistoryList(assetId);
  if(h.length===0) return;
  h.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  h.pop();
  setAssetHistoryList(assetId, h);
  saveState();
}
function manageAssetHistory(assetId){
  sortAssetHistory(assetId);
  const h = getAssetHistoryList(assetId);
  const current = h.map(x=>`${x.date} | ${x.totalNative} | ${x.note||""}`).join("\n") || "(vazio)";
  const msg =
`Cole/edite aqui seu histórico do ativo (um por linha) no formato:
YYYY-MM-DD | 12345.67 | nota opcional

ATENÇÃO: use ponto no decimal (.)
(O valor é na moeda do ativo.)`;

  const edited = prompt(msg + "\n\nConteúdo atual:\n" + current, current);
  if(edited===null) return;

  const lines = String(edited).split("\n").map(l=>l.trim()).filter(Boolean);
  const newHist = [];
  for(const line of lines){
    if(line==="(vazio)") continue;
    const parts = line.split("|").map(p=>p.trim());
    const d = normalizeDate(parts[0]);
    const v = Number((parts[1]||"").replace(",", "."));
    const note = parts.slice(2).join(" | ").trim();
    if(!d || !Number.isFinite(v)) continue;
    newHist.push({ date:d, totalNative:v, note });
  }
  newHist.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
  setAssetHistoryList(assetId, newHist);
  saveState();
  renderAssetHistory(assetId);
  toast("Histórico do ativo atualizado.");
}

/* =========================
   Gráficos (canvas)
   ========================= */
function setupCanvasHiDpi(canvas){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.clientWidth || 800;
  const cssH = canvas.clientHeight || 240;
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return { ctx, cssW, cssH };
}

function drawLineChart({canvas, points, formatValue, colorUp, colorDown, emptyText}){
  const { ctx, cssW, cssH } = setupCanvasHiDpi(canvas);
  ctx.clearRect(0,0,cssW,cssH);

  ctx.fillStyle = "rgba(255,255,255,.02)";
  ctx.fillRect(0,0,cssW,cssH);

  if(!points || points.length < 2){
    ctx.fillStyle = "rgba(169,189,216,.92)";
    ctx.font = "13px " + getComputedStyle(document.documentElement).getPropertyValue("--sans");
    ctx.fillText(emptyText || "Adicione ao menos 2 pontos para ver o gráfico.", 14, 28);
    return;
  }

  const pad = 14;
  const W = cssW - pad*2;
  const H = cssH - pad*2;

  const values = points.map(p=>p.v);
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const range = (maxV - minV) || 1;

  ctx.strokeStyle = "rgba(255,255,255,.06)";
  ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){
    const y = pad + (H*(i/4));
    ctx.beginPath();
    ctx.moveTo(pad, y);
    ctx.lineTo(pad+W, y);
    ctx.stroke();
  }

  const up = values[values.length-1] >= values[0];
  ctx.strokeStyle = up ? (colorUp || "rgba(43,213,116,.92)") : (colorDown || "rgba(255,92,108,.92)");
  ctx.lineWidth = 2.4;

  ctx.beginPath();
  points.forEach((p, i)=>{
    const x = pad + (W*(i/(points.length-1)));
    const y = pad + (H*(1 - ((p.v - minV)/range)));
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,.85)";
  points.forEach((p, i)=>{
    const x = pad + (W*(i/(points.length-1)));
    const y = pad + (H*(1 - ((p.v - minV)/range)));
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  });

  ctx.fillStyle = "rgba(169,189,216,.95)";
  ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue("--mono");
  ctx.fillText(points[0].label, pad, cssH - 8);
  const endLabel = points[points.length-1].label;
  const endW = ctx.measureText(endLabel).width;
  ctx.fillText(endLabel, pad + W - endW, cssH - 8);

  ctx.fillText(formatValue(maxV), pad, 14);
  ctx.fillText(formatValue(minV), pad, cssH - 24);
}

/* =========================
   Render histórico geral
   ========================= */
function renderHistory(){
  sortHistory();
  const h = state.history;
  const tbody = el("historyTbody");
  tbody.innerHTML = "";

  if(h.length===0){
    el("historySummary").innerHTML = `<span class="muted">Nenhum snapshot ainda. Use “Salvar snapshot” no fim do mês (ou adicione histórico antigo em “Gerenciar”).</span>`;
    drawLineChart({
      canvas: el("historyChart"),
      points: [],
      formatValue: (v)=>fmtMoney(v,"BRL"),
      emptyText: "Adicione ao menos 2 snapshots para ver o gráfico."
    });
    return;
  }

  let first = h[0].totalBRL;
  let last = h[h.length-1].totalBRL;
  const growth = (first>0) ? ((last-first)/first)*100 : null;

  el("historySummary").innerHTML =
    `Registros: <b class="mono">${h.length}</b> • Primeiro: <b class="mono">${h[0].date}</b> • Último: <b class="mono">${h[h.length-1].date}</b>
     <br/>Crescimento no período: <b class="mono ${growth>=0?'pos':'neg'}">${fmtMoney(last-first,'BRL')}</b> ${growth===null?'':`(<b class="mono ${growth>=0?'pos':'neg'}">${fmtPct(growth)}</b>)`}`;

  for(let i=0;i<h.length;i++){
    const cur = h[i];
    const prev = i>0 ? h[i-1] : null;
    const delta = prev ? (cur.totalBRL - prev.totalBRL) : null;
    const pct = (prev && prev.totalBRL>0) ? (delta/prev.totalBRL)*100 : null;
    const cls = delta===null ? "muted" : (delta>=0 ? "pos" : "neg");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div class="mono">${cur.date}</div>
          ${cur.note?`<div class="muted" style="font-size:12px;">${escapeHtml(cur.note)}</div>`:""}
        </div>
      </td>
      <td class="right mono">${fmtMoney(cur.totalBRL,'BRL')}</td>
      <td class="right mono ${cls}">${delta===null?"—":fmtMoney(delta,'BRL')}</td>
      <td class="right mono ${cls}">${pct===null?"—":fmtPct(pct)}</td>
    `;
    tbody.appendChild(tr);
  }

  const points = h.map(x=>({ label:x.date, v:x.totalBRL }));
  drawLineChart({
    canvas: el("historyChart"),
    points,
    formatValue: (v)=>fmtMoney(v,"BRL"),
    emptyText: "Adicione ao menos 2 snapshots para ver o gráfico."
  });
}

/* =========================
   Render histórico por ativo
   ========================= */
let selectedAssetId = null;

function renderAssetHistory(assetId){
  const asset = state.assets.find(a=>a.id===assetId);
  if(!asset){
    el("assetHistoryTitle").textContent = "Histórico — ativo";
    el("assetHistoryMeta").textContent = "Selecione um ativo na tabela para visualizar e editar o histórico.";
    el("assetHistorySummary").innerHTML = `<span class="muted">Nenhum ativo selecionado.</span>`;
    el("assetHistoryTbody").innerHTML = "";
    drawLineChart({
      canvas: el("assetHistoryChart"),
      points: [],
      formatValue: (v)=>fmtMoney(v,"BRL"),
      emptyText: "Selecione um ativo para ver o gráfico."
    });
    return;
  }

  selectedAssetId = assetId;

  showHistoryMode("asset");

  el("assetHistoryTitle").textContent = `Histórico — ${asset.name}${asset.symbol?` (${asset.symbol})`:``}`;
  el("assetHistoryMeta").textContent = `Moeda do ativo: ${asset.currency} • Conta: ${asset.account} • Categoria: ${asset.category}`;

  const todayISO = new Date().toISOString().slice(0,10);
  el("assetSnapDate").value = el("assetSnapDate").value || todayISO;

  sortAssetHistory(assetId);
  const h = getAssetHistoryList(assetId);
  const tbody = el("assetHistoryTbody");
  tbody.innerHTML = "";

  if(h.length===0){
    el("assetHistorySummary").innerHTML = `<span class="muted">Nenhum registro para este ativo. Use “Salvar no ativo” para criar.</span>`;
    drawLineChart({
      canvas: el("assetHistoryChart"),
      points: [],
      formatValue: (v)=>fmtMoney(v, asset.currency),
      emptyText: "Adicione ao menos 2 registros para ver o gráfico."
    });
    return;
  }

  const first = h[0].totalNative;
  const last = h[h.length-1].totalNative;
  const growth = (first>0) ? ((last-first)/first)*100 : null;

  el("assetHistorySummary").innerHTML =
    `Registros: <b class="mono">${h.length}</b> • Primeiro: <b class="mono">${h[0].date}</b> • Último: <b class="mono">${h[h.length-1].date}</b>
     <br/>Variação no período: <b class="mono ${growth>=0?'pos':'neg'}">${fmtMoney(last-first, asset.currency)}</b> ${growth===null?'':`(<b class="mono ${growth>=0?'pos':'neg'}">${fmtPct(growth)}</b>)`}`;

  for(let i=0;i<h.length;i++){
    const cur = h[i];
    const prev = i>0 ? h[i-1] : null;
    const delta = prev ? (cur.totalNative - prev.totalNative) : null;
    const pct = (prev && prev.totalNative>0) ? (delta/prev.totalNative)*100 : null;
    const cls = delta===null ? "muted" : (delta>=0 ? "pos" : "neg");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div class="mono">${cur.date}</div>
          ${cur.note?`<div class="muted" style="font-size:12px;">${escapeHtml(cur.note)}</div>`:""}
        </div>
      </td>
      <td class="right mono">${fmtMoney(cur.totalNative, asset.currency)}</td>
      <td class="right mono ${cls}">${delta===null?"—":fmtMoney(delta, asset.currency)}</td>
      <td class="right mono ${cls}">${pct===null?"—":fmtPct(pct)}</td>
    `;
    tbody.appendChild(tr);
  }

  const points = h.map(x=>({ label:x.date, v:x.totalNative }));
  drawLineChart({
    canvas: el("assetHistoryChart"),
    points,
    formatValue: (v)=>fmtMoney(v, asset.currency),
    emptyText: "Adicione ao menos 2 registros para ver o gráfico."
  });
}

/* =========================
   Render principal
   ========================= */
function render(){
  el("fxUSDBRL").textContent = market.fx.USDBRL ? fmtNum(market.fx.USDBRL, 4) : "—";
  el("fxEURBRL").textContent = market.fx.EURBRL ? fmtNum(market.fx.EURBRL, 4) : "—";

  const selicAA = market.br.selicAnnualApprox;
  const cdiAA = market.br.cdiAnnualApprox;
  el("ratesMeta").textContent =
    (selicAA===null || cdiAA===null) ? "SELIC/CDI: —" : `SELIC ~ ${(selicAA*100).toFixed(2)}% a.a. • CDI ~ ${(cdiAA*100).toFixed(2)}% a.a.`;

  const filter = (el("filterInput").value || "").trim().toLowerCase();
  const tbody = el("tbody");
  tbody.innerHTML = "";

  let totalBRL = 0;
  let totalPnL = 0;
  let total24h = 0;
  let total24hBase = 0;

  const rows = state.assets.map(a=>{
    const c = computeRow(a);
    return { a, c };
  });

  rows.forEach(({a,c})=>{
    const key = `${a.name} ${a.symbol||""} ${a.account} ${a.category}`.toLowerCase();
    if(filter && !key.includes(filter)) return;

    if(c.valueBRL !== null) totalBRL += c.valueBRL;
    if(c.pnlBRL !== null) totalPnL += c.pnlBRL;

    if(c.change !== null && c.valueBRL !== null){
      total24h += c.valueBRL * (c.change/100);
      total24hBase += c.valueBRL;
    }

    const tr = document.createElement("tr");
    tr.classList.add("clickableRow");
    tr.dataset.assetId = a.id;

    const statusDot =
      (a.mode==="crypto" || a.mode==="stock_b3" || a.mode==="fund_ishares_auto") ? "green" :
      (a.mode==="fund_manual") ? "yellow" :
      (a.mode==="rf_selic" || a.mode==="rf_cdi" || a.mode==="rf_cdi_proxy_fund") ? "blue" : "blue";

    const statusText =
      (a.mode==="crypto" || a.mode==="stock_b3" || a.mode==="fund_ishares_auto") ? "Automático" :
      (a.mode==="fund_manual") ? "Preço manual" :
      (a.mode==="rf_selic" || a.mode==="rf_cdi" || a.mode==="rf_cdi_proxy_fund") ? "Taxa automática" : "Manual";

    const qtyLabel = (a.mode==="manual_balance") ? "Saldo" : "Qtd";
    const qtyDisplay = (a.mode==="manual_balance") ? fmtMoney(Number(a.qty||0), a.currency) : fmtNum(Number(a.qty||0), 8);

    const priceDisplay = (c.price===null) ? "—" : (
      a.mode==="manual_balance" ? "—" : fmtMoney(c.price, a.currency)
    );

    const valueNativeDisplay = c.valueNative===null ? "—" : fmtMoney(c.valueNative, a.currency);
    const valueBRLDisplay = c.valueBRL===null ? "—" : fmtMoney(c.valueBRL, "BRL");
    const valueBRLNetDisplay = (c.valueBRLNet===null) ? "—" : fmtMoney(c.valueBRLNet, "BRL");
    const taxesBRLDisplay = (c.taxesBRL===null) ? "—" : fmtMoney(c.taxesBRL, "BRL");

    const pnlClass = (c.pnlBRL===null) ? "muted" : (c.pnlBRL>=0 ? "pos" : "neg");
    const pnlDisplay = (c.pnlBRL===null) ? "—" : fmtMoney(c.pnlBRL, "BRL");

    const chgClass = (c.change===null) ? "muted" : (c.change>=0 ? "pos" : "neg");
    const chgDisplay = (c.change===null) ? "—" : fmtPct(c.change);

    tr.innerHTML = `
      <td>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div style="font-weight:900;">
            ${escapeHtml(a.name)} ${a.symbol?`<span class="muted mono">(${escapeHtml(a.symbol)})</span>`:""}
          </div>
          <div class="muted" style="font-size:12.5px;">
            <span class="mono">${escapeHtml(a.currency)}</span>
            ${a.notes ? ` • ${escapeHtml(a.notes)}` : ""}
          </div>
        </div>
      </td>
      <td class="muted">${escapeHtml(a.category)}</td>
      <td class="muted">${escapeHtml(a.account)}</td>
      <td class="right">
        <span class="muted">${qtyLabel}:</span>
        <span class="mono" style="font-weight:900;">${qtyDisplay}</span>
      </td>
      <td class="right mono">${priceDisplay}</td>
      <td class="right mono">${valueNativeDisplay}</td>
      <td class="right mono" style="font-weight:900;">${valueBRLDisplay}</td>
      <td class="right mono" style="font-weight:900;">${valueBRLNetDisplay}</td>
      <td class="right mono muted">${taxesBRLDisplay}</td>
      <td class="right mono ${pnlClass}">${pnlDisplay}</td>
      <td class="right mono ${chgClass}">${chgDisplay}</td>
      <td>
        <span class="tag"><span class="dot ${statusDot}"></span>${statusText}</span>
      </td>
      <td class="right">
        <div class="rowActions">
          <button class="btn small" data-action="history" data-asset="${escapeHtml(a.id)}" title="Abrir histórico do ativo">Histórico</button>
          <button class="btn small primary" data-action="edit" data-asset="${escapeHtml(a.id)}" title="Editar este investimento">Editar</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  el("kpiTotalBRL").textContent = fmtMoney(totalBRL, "BRL");

  const pnlEl = el("kpiPnL");
  pnlEl.textContent = (isFinite(totalPnL) && totalPnL!==0) ? fmtMoney(totalPnL, "BRL") : (totalPnL===0 ? fmtMoney(0,"BRL") : "—");
  pnlEl.className = "value mono " + (totalPnL>0 ? "pos" : (totalPnL<0 ? "neg" : ""));

  const pct24h = (total24hBase>0) ? (total24h/total24hBase)*100 : null;
  const k24 = el("kpi24h");
  k24.textContent = (pct24h===null) ? "—" : `${fmtMoney(total24h,"BRL")} (${fmtPct(pct24h)})`;
  k24.className = "value mono " + (pct24h>0 ? "pos" : (pct24h<0 ? "neg" : ""));

  el("kpiTotalSub").textContent =
    `Ativos: ${state.assets.length} • Base: BRL • Auto-refresh: ${state.settings.autoRefreshMinutes} min`;

  el("metaInfo").textContent =
    market.errors.length ? `Avisos: ${market.errors.join(" | ")}` :
    `Fontes: FX Frankfurter • SELIC/CDI BCB (SGS) • BTC CoinGecko • B3 brapi.dev`;

  el("lastUpdated").textContent = market.lastUpdated ? new Date(market.lastUpdated).toLocaleString("pt-BR") : "—";

  renderHistory();

  if(selectedAssetId && isAssetMode()){
    renderAssetHistory(selectedAssetId);
  }
}

/* =========================
   Edição individual
   ========================= */
let editingAssetId = null;

function openEditAsset(assetId){
  const asset = state.assets.find(a=>a.id===assetId);
  if(!asset){ toast("Ativo não encontrado."); return; }

  editingAssetId = assetId;

  el("assetEditOverlay").classList.add("show");

  el("editTitle").textContent = `Editar — ${asset.name}${asset.symbol?` (${asset.symbol})`:``}`;
  el("editSub").textContent = `${asset.category} • ${asset.account} • Moeda: ${asset.currency}`;

  const isBalance = asset.mode==="manual_balance";
  el("editQtyLabel").textContent = isBalance ? "Saldo (valor total)" : "Quantidade";
  el("editQtyHint").textContent = isBalance
    ? "Digite o saldo atual (na moeda do ativo)."
    : "Digite a quantidade de unidades/cotas.";
  el("editQty").value = String(asset.qty ?? 0);

  el("editAvgCost").disabled = isBalance || (asset.mode==="rf_selic" || asset.mode==="rf_cdi" || asset.mode==="rf_cdi_proxy_fund");
  el("editAvgCost").value = (asset.avgCost===null || asset.avgCost===undefined) ? "" : String(asset.avgCost);

  const lotsRow = el("lotsRow");
  if(asset.mode === "rf_selic" || asset.mode === "rf_cdi" || asset.mode === "rf_cdi_proxy_fund"){
    lotsRow.style.display = "";
    const lots = Array.isArray(asset.lots) ? asset.lots : [];
    el("editLots").value = lots.map(x=>`${x.date} | ${x.amount}`).join("\n");
    el("editQtyHint").textContent = "Se usar lotes, o painel ignora o campo “Quantidade/Saldo” para cálculo bruto/líquido.";
  }else{
    lotsRow.style.display = "none";
    el("editLots").value = "";
  }

  const manualRow = el("manualPriceRow");
  if(asset.mode==="fund_manual"){
    manualRow.style.display = "";
    el("editManualPrice").value = String(state.manualPrices?.[asset.id]?.price ?? 0);
  }else{
    manualRow.style.display = "none";
    el("editManualPrice").value = "";
  }

  el("editNotesShort").value = "";
  el("editNotes").value = String(asset.notes ?? "");
}

function closeEditAsset(){
  editingAssetId = null;
  el("assetEditOverlay").classList.remove("show");
}

function saveEditAsset(){
  if(!editingAssetId) return;
  const asset = state.assets.find(a=>a.id===editingAssetId);
  if(!asset){ toast("Ativo não encontrado."); return; }

  const qty = Number(String(el("editQty").value||"").replace(",", "."));
  if(!Number.isFinite(qty)){
    toast("Quantidade/saldo inválido.");
    return;
  }
  asset.qty = qty;

  if(!(asset.mode==="rf_selic" || asset.mode==="rf_cdi" || asset.mode==="rf_cdi_proxy_fund") && asset.mode!=="manual_balance"){
    const rawAvg = String(el("editAvgCost").value||"").trim();
    if(rawAvg==="") asset.avgCost = null;
    else{
      const avg = Number(rawAvg.replace(",", "."));
      asset.avgCost = Number.isFinite(avg) ? avg : null;
    }
  }else{
    asset.avgCost = null;
  }

  if(asset.mode==="fund_manual"){
    const rawP = String(el("editManualPrice").value||"").trim();
    const p = Number(rawP.replace(",", "."));
    if(!Number.isFinite(p)){
      toast("Preço manual inválido.");
      return;
    }
    state.manualPrices[asset.id] = { price: p };
  }

  const short = String(el("editNotesShort").value||"").trim();
  const notes = String(el("editNotes").value||"").trim();
  asset.notes = notes || asset.notes || "";
  if(short && !asset.notes.includes(short)){
    asset.notes = asset.notes ? (asset.notes + " • " + short) : short;
  }

  if(asset.mode === "rf_selic" || asset.mode === "rf_cdi" || asset.mode === "rf_cdi_proxy_fund"){
    const raw = String(el("editLots").value||"").trim();
    const lines = raw ? raw.split("\n").map(l=>l.trim()).filter(Boolean) : [];
    const newLots = [];
    for(const line of lines){
      const parts = line.split("|").map(p=>p.trim());
      const d = normalizeDate(parts[0]);
      const amt = Number(String(parts[1]||"").replace(",", "."));
      if(!d || !Number.isFinite(amt) || amt<=0) continue;
      newLots.push({ date:d, amount: amt });
    }
    newLots.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    asset.lots = newLots;
    market.br.histStartISO = null;
  }

  saveState();
  render();
  toast("Investimento atualizado.");
  closeEditAsset();
}

/* =========================
   Edit modal legado (mantido)
   ========================= */
async function editQuantities(){
  for(const a of state.assets){
    const label = (a.mode==="manual_balance") ? "Saldo (valor total)" : "Quantidade";
    const v = prompt(`${a.name} (${a.account})\n${label} em ${a.currency}:`, String(a.qty ?? 0));
    if(v===null) return;
    const num = Number(v.replace(",", "."));
    if(!Number.isFinite(num)) { toast("Valor inválido. Mantive o anterior."); continue; }
    a.qty = num;

    if(a.mode!=="manual_balance" && !(a.mode==="rf_selic" || a.mode==="rf_cdi" || a.mode==="rf_cdi_proxy_fund")){
      const ac = prompt(`${a.name}\nPreço médio (opcional) em ${a.currency}.\nDeixe vazio para ignorar PnL.`, (a.avgCost ?? "")==="null" ? "" : String(a.avgCost ?? ""));
      if(ac===null) return;
      const trimmed = String(ac).trim();
      a.avgCost = trimmed==="" ? null : Number(trimmed.replace(",", "."));
      if(a.avgCost !== null && !Number.isFinite(a.avgCost)) a.avgCost = null;
    }else{
      a.avgCost = null;
    }

    if(a.mode==="fund_manual"){
      const p = prompt(`${a.name}\nPreço por cota (manual) em ${a.currency}:`, String(state.manualPrices[a.id]?.price ?? 0));
      if(p===null) return;
      const pn = Number(String(p).replace(",", "."));
      if(Number.isFinite(pn)) state.manualPrices[a.id] = { price: pn };
    }
  }
  saveState();
  render();
  toast("Quantidades/saldos atualizados.");
}

/* =========================
   Gerenciar histórico geral
   ========================= */
function manageHistory(){
  sortHistory();
  const current = state.history.map(h=>`${h.date} | ${h.totalBRL} | ${h.note||""}`).join("\n") || "(vazio)";
  const msg =
`Cole/edite aqui sua lista de snapshots (um por linha) no formato:
YYYY-MM-DD | 12345.67 | nota opcional

Exemplo:
2021-12-31 | 3500.00 | início
2022-12-31 | 12000.00 | fim do ano

ATENÇÃO: use ponto no decimal (.)`;

  const edited = prompt(msg + "\n\nConteúdo atual:\n" + current, current);
  if(edited===null) return;

  const lines = String(edited).split("\n").map(l=>l.trim()).filter(Boolean);
  const newHist = [];
  for(const line of lines){
    if(line==="(vazio)") continue;
    const parts = line.split("|").map(p=>p.trim());
    const d = normalizeDate(parts[0]);
    const v = Number((parts[1]||"").replace(",", "."));
    const note = parts.slice(2).join(" | ").trim();
    if(!d || !Number.isFinite(v)) continue;
    newHist.push({ date:d, totalBRL:v, note });
  }
  state.history = newHist;
  sortHistory();
  saveState();
  renderHistory();
  toast("Histórico atualizado.");
}

/* =========================
   Import/Export JSON
   ========================= */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "invest_dashboard_data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async () => {
    const file = inp.files?.[0];
    if(!file) return;
    const txt = await file.text();
    try{
      const parsed = JSON.parse(txt);
      const assets = Array.isArray(parsed.assets) ? parsed.assets.filter(a => a.id !== "usd_cash") : undefined;

      state = {
        ...deepClone(DEFAULT_DATA),
        ...parsed,
        assets: assets ?? deepClone(DEFAULT_DATA.assets),
        settings: { ...DEFAULT_DATA.settings, ...(parsed.settings||{}) },
        manualPrices: { ...DEFAULT_DATA.manualPrices, ...(parsed.manualPrices||{}) },
        history: Array.isArray(parsed.history) ? parsed.history : [],
        assetHistory: (parsed.assetHistory && typeof parsed.assetHistory==="object") ? parsed.assetHistory : {}
      };
      saveState();
      market.br.histStartISO = null;
      render();
      toast("Importado com sucesso.");
    }catch{
      toast("Falha ao importar JSON.");
    }
  };
  inp.click();
}

/* =========================
   Alternância histórico
   ========================= */
function isAssetMode(){
  return el("assetHistoryCard").classList.contains("show");
}
function showHistoryMode(mode){
  const portfolioCard = el("portfolioHistoryCard");
  const assetCard = el("assetHistoryCard");
  const p1 = el("modePortfolioBtn"), a1 = el("modeAssetBtn");
  const p2 = el("modePortfolioBtn2"), a2 = el("modeAssetBtn2");

  if(mode==="asset"){
    portfolioCard.style.display = "none";
    assetCard.classList.add("show");
    p1.classList.remove("active"); a1.classList.add("active");
    p2.classList.remove("active"); a2.classList.add("active");
  }else{
    portfolioCard.style.display = "";
    assetCard.classList.remove("show");
    p1.classList.add("active"); a1.classList.remove("active");
    p2.classList.add("active"); a2.classList.remove("active");
  }
}

/* =========================
   Refresh
   ========================= */
async function refreshAll(){
  market.errors = [];

  try{ await fetchFX(); }
  catch(e){ market.errors.push(`FX ${String(e?.message||"indisponível")}`); }

  try{ await fetchBRRatesAndHistory(); }
  catch(e){ market.errors.push(`SELIC/CDI ${String(e?.message||"indisponível")}`); }

  if(market.fx.USDBRL === null || market.fx.EURBRL === null){
    market.errors.push("Câmbio incompleto");
  }

  try{ await fetchCrypto(); }
  catch(e){ market.errors.push(`BTC ${String(e?.message||"indisponível")}`); }

  // B3: erros por ticker aparecem dentro de fetchB3Quotes() (com HTTP e status)
  try{ await fetchB3Quotes(); }
  catch(e){ market.errors.push(`B3 ${String(e?.message||"indisponível")}`); }

  try{ await fetchIsharesWorld(); }catch(e){ /* já tratado */ }

  market.lastUpdated = Date.now();
  render();
}

/* =========================
   Events
   ========================= */
el("refreshBtn").addEventListener("click", async ()=>{
  toast("Atualizando…");
  await refreshAll();
  toast("Atualizado.");
});
el("editBtn").addEventListener("click", editQuantities);
el("exportBtn").addEventListener("click", exportJSON);
el("importBtn").addEventListener("click", importJSON);
el("resetBtn").addEventListener("click", ()=>{
  const ok = confirm("Tem certeza? Isso apaga os dados salvos no navegador.");
  if(!ok) return;
  localStorage.removeItem(STORAGE_KEY);
  state = deepClone(DEFAULT_DATA);
  saveState();
  market.br.histStartISO = null;
  render();
  toast("Resetado.");
});
el("filterInput").addEventListener("input", render);

// Histórico geral
const todayISO = new Date().toISOString().slice(0,10);
el("snapDate").value = todayISO;

el("saveSnapshotBtn").addEventListener("click", ()=>{
  const date = el("snapDate").value || todayISO;
  const note = el("snapNote").value || "";
  const total = computeTotalBRL();
  const ok = upsertSnapshot(date, total, note);
  if(ok){
    toast("Snapshot salvo.");
    el("snapNote").value = "";
    renderHistory();
  }
});
el("manageHistoryBtn").addEventListener("click", manageHistory);
el("deleteLastSnapshotBtn").addEventListener("click", ()=>{
  if(state.history.length===0){ toast("Não há snapshots."); return; }
  const ok = confirm("Apagar o último snapshot? Isso não tem como desfazer.");
  if(!ok) return;
  deleteLastSnapshot();
  renderHistory();
  toast("Último snapshot apagado.");
});

// Toggle histórico
el("modePortfolioBtn").addEventListener("click", ()=>showHistoryMode("portfolio"));
el("modePortfolioBtn2").addEventListener("click", ()=>showHistoryMode("portfolio"));
el("modeAssetBtn").addEventListener("click", ()=>{
  if(!selectedAssetId){ toast("Selecione um ativo na tabela."); return; }
  showHistoryMode("asset");
  renderAssetHistory(selectedAssetId);
});
el("modeAssetBtn2").addEventListener("click", ()=>{
  if(!selectedAssetId){ toast("Selecione um ativo na tabela."); return; }
  showHistoryMode("asset");
  renderAssetHistory(selectedAssetId);
});
el("assetBackBtn").addEventListener("click", ()=>showHistoryMode("portfolio"));

// Histórico por ativo
el("assetSnapDate").value = todayISO;

el("saveAssetSnapshotBtn").addEventListener("click", ()=>{
  if(!selectedAssetId){ toast("Selecione um ativo primeiro."); return; }
  const asset = state.assets.find(a=>a.id===selectedAssetId);
  if(!asset){ toast("Ativo não encontrado."); return; }

  const date = el("assetSnapDate").value || todayISO;
  const note = el("assetSnapNote").value || "";
  const rawVal = String(el("assetSnapValue").value||"").trim();

  let val = Number(rawVal.replace(",", "."));
  if(!rawVal){
    const c = computeRow(asset);
    if(c.valueNative===null){
      toast("Não foi possível sugerir o valor atual. Preencha manualmente.");
      return;
    }
    val = Number(c.valueNative);
  }
  if(!Number.isFinite(val)){ toast("Valor inválido."); return; }

  const ok = upsertAssetSnapshot(selectedAssetId, date, val, note);
  if(ok){
    toast("Registro salvo no ativo.");
    el("assetSnapNote").value = "";
    el("assetSnapValue").value = "";
    renderAssetHistory(selectedAssetId);
  }
});
el("manageAssetHistoryBtn").addEventListener("click", ()=>{
  if(!selectedAssetId){ toast("Selecione um ativo primeiro."); return; }
  manageAssetHistory(selectedAssetId);
});
el("deleteLastAssetSnapshotBtn").addEventListener("click", ()=>{
  if(!selectedAssetId){ toast("Selecione um ativo primeiro."); return; }
  const h = getAssetHistoryList(selectedAssetId);
  if(h.length===0){ toast("Não há registros nesse ativo."); return; }
  const ok = confirm("Apagar o último registro deste ativo? Isso não tem como desfazer.");
  if(!ok) return;
  deleteLastAssetSnapshot(selectedAssetId);
  renderAssetHistory(selectedAssetId);
  toast("Último registro apagado.");
});

// Modal edição individual
el("closeEditBtn").addEventListener("click", closeEditAsset);
el("cancelEditBtn").addEventListener("click", closeEditAsset);
el("saveEditBtn").addEventListener("click", saveEditAsset);
el("assetEditOverlay").addEventListener("click", (e)=>{
  if(e.target === el("assetEditOverlay")) closeEditAsset();
});
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape" && el("assetEditOverlay").classList.contains("show")) closeEditAsset();
});

// Delegação de cliques na tabela
el("tbody").addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-action]");
  if(btn){
    e.stopPropagation();
    const assetId = btn.getAttribute("data-asset");
    const action = btn.getAttribute("data-action");
    if(action==="edit") openEditAsset(assetId);
    if(action==="history"){
      selectedAssetId = assetId;
      renderAssetHistory(assetId);
    }
    return;
  }

  const row = e.target.closest("tr[data-asset-id]");
  if(row){
    const assetId = row.getAttribute("data-asset-id");
    selectedAssetId = assetId;
    renderAssetHistory(assetId);
  }
});

/* =========================
   Boot
   ========================= */
render();
refreshAll();
setInterval(refreshAll, Math.max(5, Number(state.settings.autoRefreshMinutes||30)) * 60 * 1000);
</script>
</body>
</html>
