<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard de Investimentos — BRL Base</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#101826;
      --card2:#0f1622;
      --text:#e8eef7;
      --muted:#9bb0c9;
      --line:#1f2b3a;

      --green:#22c55e;
      --red:#ef4444;
      --yellow:#f59e0b;
      --blue:#60a5fa;
      --pill:#0b1220;

      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0; background:radial-gradient(1200px 700px at 20% 10%, rgba(96,165,250,.12), transparent 55%),
                           radial-gradient(900px 600px at 90% 20%, rgba(34,197,94,.10), transparent 60%),
                           radial-gradient(900px 600px at 30% 90%, rgba(239,68,68,.08), transparent 60%),
                           var(--bg);
      color:var(--text); font-family:var(--sans);
    }

    header{
      padding:22px 18px 10px;
      max-width:1180px; margin:0 auto;
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }

    .title h1{margin:0; font-size:20px; letter-spacing:.2px}
    .title p{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35}

    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.22);
      font-size:13px;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.primary{
      border:1px solid rgba(96,165,250,.35);
      background:linear-gradient(180deg, rgba(96,165,250,.20), rgba(96,165,250,.08));
    }
    .btn.danger{
      border:1px solid rgba(239,68,68,.35);
      background:linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.08));
    }

    main{max-width:1180px; margin:0 auto; padding:10px 18px 26px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      overflow:hidden;
    }

    .kpi{grid-column: span 3;}
    @media (max-width: 980px){ .kpi{grid-column: span 6;} }
    @media (max-width: 520px){ .kpi{grid-column: span 12;} }

    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{margin-top:8px; font-size:20px; font-weight:700; letter-spacing:.2px}
    .kpi .sub{margin-top:6px; font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:12px;
    }
    .pill strong{color:var(--text); font-family:var(--mono); font-weight:700}

    .tableCard{grid-column: span 12; padding:0}
    .tableHeader{
      padding:14px;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .tableHeader h2{margin:0; font-size:14px}
    .tableHeader .meta{color:var(--muted); font-size:12px}
    .tableWrap{overflow:auto}
    table{width:100%; border-collapse:collapse; min-width:980px}
    th, td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.05);
      vertical-align:middle;
      font-size:12.5px;
      white-space:nowrap;
    }
    th{color:var(--muted); font-weight:600; text-align:left; background:rgba(255,255,255,.02)}
    tr:hover td{background:rgba(255,255,255,.02)}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .pos{color:var(--green); font-weight:700}
    .neg{color:var(--red); font-weight:700}
    .warn{color:var(--yellow); font-weight:700}
    .tag{
      display:inline-flex; align-items:center;
      padding:5px 9px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:12px;
      gap:8px;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.25)}
    .dot.green{background:var(--green)}
    .dot.red{background:var(--red)}
    .dot.blue{background:var(--blue)}
    .dot.yellow{background:var(--yellow)}
    .inlineInputs{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    input[type="number"], input[type="text"]{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:9px 10px;
      color:var(--text);
      font-size:13px;
      outline:none;
      width:160px;
    }
    input[type="text"]{width:220px}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .small{width:120px !important}

    .footerNote{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .toast{
      position:fixed; bottom:18px; right:18px;
      background:rgba(16,24,38,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 14px;
      box-shadow:var(--shadow);
      color:var(--text);
      font-size:13px;
      display:none;
      max-width:360px;
    }
    .toast.show{display:block}
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>Dashboard de Investimentos (Base BRL)</h1>
    <p>
      Simples de usar, mas robusto: você atualiza quantidades/saldos quando quiser, e o painel puxa <b>câmbio e cotações</b> automaticamente.
      <br><span class="muted">Verde = ganho, vermelho = perda. Valores em moeda original e convertido em BRL.</span>
    </p>
  </div>

  <div class="actions">
    <span class="pill">Última atualização: <strong id="lastUpdated">—</strong></span>
    <button class="btn primary" id="refreshBtn">Atualizar agora</button>
    <button class="btn" id="editBtn">Editar quantidades</button>
    <button class="btn danger" id="resetBtn">Resetar dados</button>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card kpi">
      <div class="label">Patrimônio total (BRL)</div>
      <div class="value mono" id="kpiTotalBRL">—</div>
      <div class="sub" id="kpiTotalSub">—</div>
    </div>

    <div class="card kpi">
      <div class="label">Ganho/Perda estimado (BRL)</div>
      <div class="value mono" id="kpiPnL">—</div>
      <div class="sub muted">Baseado em preço atual vs preço médio (quando informado)</div>
    </div>

    <div class="card kpi">
      <div class="label">Variação 24h (aprox.)</div>
      <div class="value mono" id="kpi24h">—</div>
      <div class="sub muted">Para ativos com fonte de cotação (BTC e ações B3)</div>
    </div>

    <div class="card kpi">
      <div class="label">Câmbio (para conversão)</div>
      <div class="value" style="display:flex; gap:10px; flex-wrap:wrap;">
        <span class="tag"><span class="dot blue"></span><span>USD/BRL</span> <span class="mono" id="fxUSDBRL">—</span></span>
        <span class="tag"><span class="dot yellow"></span><span>EUR/BRL</span> <span class="mono" id="fxEURBRL">—</span></span>
      </div>
      <div class="sub muted">Taxas de referência via Frankfurter (ECB)</div>
    </div>

    <div class="card tableCard">
      <div class="tableHeader">
        <div>
          <h2>Carteira — visão consolidada</h2>
          <div class="meta" id="metaInfo">—</div>
        </div>
        <div class="inlineInputs">
          <input type="text" id="filterInput" placeholder="Filtrar (ex: VALE3, BTC, Nubank)" />
          <button class="btn" id="exportBtn">Exportar JSON</button>
          <button class="btn" id="importBtn">Importar JSON</button>
        </div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ativo</th>
              <th>Categoria</th>
              <th>Conta</th>
              <th class="right">Quantidade / Saldo</th>
              <th class="right">Preço atual</th>
              <th class="right">Valor (moeda)</th>
              <th class="right">Valor (BRL)</th>
              <th class="right">G/P (BRL)</th>
              <th class="right">24h</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="tableHeader" style="border-top:1px solid rgba(255,255,255,.06); border-bottom:none;">
        <div class="footerNote">
          <b>Notas rápidas</b><br/>
          1) “Preço atual” é automático para BTC (CoinGecko) e ações B3 (brapi). Fundos/renda fixa ficam manual (você atualiza saldo).<br/>
          2) O painel atualiza sozinho enquanto estiver aberto. Se você quiser atualização diária mesmo com o navegador fechado, isso exige hospedar com um job/cron (posso te passar um blueprint depois).<br/>
          3) Isso é uma ferramenta de acompanhamento, não é recomendação de investimento.
        </div>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/* =========================
   Config / Fontes
   - FX: Frankfurter (ECB)
   - BTC: CoinGecko
   - Ações B3: brapi.dev
   ========================= */

const STORAGE_KEY = "inv_dashboard_v1";

/**
 * Estrutura de ativo:
 * {
 *  id, name, category, account,
 *  currency: "BRL"|"USD"|"EUR",
 *  mode: "stock_b3"|"crypto"|"cash"|"manual_balance"|"fund_manual",
 *  symbol: (para stock_b3 ex: "VALE3"),
 *  coingeckoId: (para crypto ex: "bitcoin"),
 *  qty: number (ou balance),
 *  avgCost: number (preço médio na moeda do ativo) [opcional],
 *  notes: string
 * }
 */

const DEFAULT_DATA = {
  settings: {
    baseCurrency: "BRL",
    autoRefreshMinutes: 30
  },
  assets: [
    // Crypto
    { id:"btc", name:"Bitcoin", category:"Cripto", account:"BINANCE", currency:"USD", mode:"crypto", coingeckoId:"bitcoin", qty:0.0, avgCost:null, notes:"Qtd em BTC; preço em USD" },

    // Cash USD (Binance)
    { id:"usd_cash", name:"Dólar em conta", category:"Caixa", account:"BINANCE", currency:"USD", mode:"cash", qty:0.0, avgCost:1.0, notes:"Saldo em USD" },

    // Tesouro Direto (manual balance)
    { id:"td_selic_2026", name:"Tesouro Selic 2026", category:"Renda fixa", account:"C6", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)" },
    { id:"td_selic_2027", name:"Tesouro Selic 2027", category:"Renda fixa", account:"C6", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)" },
    { id:"td_selic_2029", name:"Tesouro Selic 2029", category:"Renda fixa", account:"C6", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)" },

    // Caixinhas / Cofrinhos (manual balance)
    { id:"nubank_caixinha", name:"Caixinha Nubank (120% CDI)", category:"Renda fixa", account:"NUBANK", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)" },
    { id:"nu_reserva", name:"Nu Reserva Imediata", category:"Fundo", account:"NUBANK", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)" },
    { id:"mp_cofrinho", name:"Cofrinho Mercado Pago (120% CDI)", category:"Renda fixa", account:"Mercado Pago", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)" },

    // Ações B3 (brapi)
    { id:"ggbr4", name:"Gerdau", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"GGBR4", qty:0.0, avgCost:null, notes:"Qtd de ações" },
    { id:"vale3", name:"Vale", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"VALE3", qty:0.0, avgCost:null, notes:"Qtd de ações" },
    { id:"cmig4", name:"Cemig", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"CMIG4", qty:0.0, avgCost:null, notes:"Qtd de ações" },
    { id:"tasa4", name:"Taurus", category:"Ações B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"TASA4", qty:0.0, avgCost:null, notes:"Qtd de ações" },

    // Fundo em EUR (manual price / manual balance)
    { id:"wise_ishares_world", name:"iShares World Equity Index Fund", category:"Fundo", account:"WISE", currency:"EUR", mode:"fund_manual", qty:0.0, avgCost:null, notes:"Qtd (cotas/unidades) + preço manual em EUR (você define)" }
  ],
  manualPrices: {
    // Para fundos manuais (EUR)
    "wise_ishares_world": { price: 0.0 } // preço por cota (EUR) — você edita
  }
};

let state = loadState();
let market = {
  fx: { USDBRL: null, EURBRL: null },
  quotes: {}, // id -> { price, changePct24h, currency }
  lastUpdated: null,
  errors: []
};

const el = (id) => document.getElementById(id);

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return structuredClone(DEFAULT_DATA);
  try{
    const parsed = JSON.parse(raw);
    // merge light
    return {
      ...structuredClone(DEFAULT_DATA),
      ...parsed,
      settings: { ...DEFAULT_DATA.settings, ...(parsed.settings||{}) },
      manualPrices: { ...DEFAULT_DATA.manualPrices, ...(parsed.manualPrices||{}) }
    };
  }catch{
    return structuredClone(DEFAULT_DATA);
  }
}

function fmtMoney(v, cur="BRL"){
  if(v === null || v === undefined || Number.isNaN(v)) return "—";
  return new Intl.NumberFormat("pt-BR", { style:"currency", currency:cur, maximumFractionDigits: 2 }).format(v);
}
function fmtNum(v, max=6){
  if(v === null || v === undefined || Number.isNaN(v)) return "—";
  return new Intl.NumberFormat("pt-BR", { maximumFractionDigits: max }).format(v);
}
function fmtPct(v){
  if(v === null || v === undefined || Number.isNaN(v)) return "—";
  const sign = v > 0 ? "+" : "";
  return sign + v.toFixed(2) + "%";
}
function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2800);
}

/* ================
   Fetchers
   ================ */
async function fetchFX(){
  // Frankfurter base EUR. Para EURBRL: from=EUR to=BRL.
  // Para USDBRL: from=USD to=BRL (Frankfurter converte via base).
  // Docs: https://frankfurter.dev  (ECB reference)
  const fx1 = fetch("https://api.frankfurter.dev/latest?from=EUR&to=BRL").then(r=>r.json());
  const fx2 = fetch("https://api.frankfurter.dev/latest?from=USD&to=BRL").then(r=>r.json());
  const [a,b] = await Promise.all([fx1, fx2]);
  const EURBRL = a?.rates?.BRL ?? null;
  const USDBRL = b?.rates?.BRL ?? null;
  market.fx.EURBRL = EURBRL;
  market.fx.USDBRL = USDBRL;
}

async function fetchCrypto(){
  // CoinGecko free endpoint geralmente funciona sem chave:
  // https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true
  const ids = state.assets.filter(x=>x.mode==="crypto").map(x=>x.coingeckoId).filter(Boolean);
  if(ids.length===0) return;

  const url = "https://api.coingecko.com/api/v3/simple/price?ids=" + encodeURIComponent(ids.join(",")) +
              "&vs_currencies=usd&include_24hr_change=true";
  const r = await fetch(url);
  if(!r.ok) throw new Error("CoinGecko falhou ("+r.status+")");
  const data = await r.json();

  for(const a of state.assets.filter(x=>x.mode==="crypto")){
    const d = data[a.coingeckoId];
    if(!d) continue;
    market.quotes[a.id] = {
      price: d.usd ?? null,
      changePct24h: d.usd_24h_change ?? null,
      currency: "USD"
    };
  }
}

async function fetchB3Quotes(){
  // brapi.dev endpoint de quote (sem autenticação pode ter limite).
  // Exemplo: https://brapi.dev/api/quote/VALE3
  const syms = state.assets.filter(x=>x.mode==="stock_b3").map(x=>x.symbol).filter(Boolean);
  if(syms.length===0) return;

  // Buscando em lote: /quote/{symbols}?symbols=... também existe, mas o mais simples aqui é serializar
  // para reduzir risco de falha por lote e manter fácil.
  const tasks = syms.map(sym => fetch(`https://brapi.dev/api/quote/${encodeURIComponent(sym)}`).then(r=>r.json()).then(j=>({sym,j})));
  const res = await Promise.allSettled(tasks);

  res.forEach((item, idx)=>{
    const sym = syms[idx];
    if(item.status!=="fulfilled") return;

    const j = item.value.j;
    const q = j?.results?.[0];
    if(!q) return;

    // Campos comuns: regularMarketPrice, regularMarketChangePercent
    const price = q.regularMarketPrice ?? null;
    const chg = q.regularMarketChangePercent ?? null;

    const asset = state.assets.find(a=>a.mode==="stock_b3" && a.symbol===sym);
    if(!asset) return;

    market.quotes[asset.id] = {
      price,
      changePct24h: chg, // mudança do dia, serve como “24h aprox”
      currency: "BRL"
    };
  });
}

function getFXToBRL(currency){
  if(currency==="BRL") return 1.0;
  if(currency==="USD") return market.fx.USDBRL;
  if(currency==="EUR") return market.fx.EURBRL;
  return null;
}

/* =========================
   Cálculos por ativo
   ========================= */
function computeRow(asset){
  // Preço atual:
  let price = null;
  let change = null;
  if(asset.mode==="crypto" || asset.mode==="stock_b3"){
    price = market.quotes[asset.id]?.price ?? null;
    change = market.quotes[asset.id]?.changePct24h ?? null;
  }else if(asset.mode==="fund_manual"){
    price = state.manualPrices?.[asset.id]?.price ?? null;
    change = null;
  }else if(asset.mode==="cash"){
    price = 1.0; // 1 USD por unidade (saldo)
    change = null;
  }else if(asset.mode==="manual_balance"){
    price = 1.0; // saldo já é valor total na moeda
    change = null;
  }

  // Valor na moeda do ativo:
  let valueNative = null;
  if(asset.mode==="manual_balance"){
    valueNative = Number(asset.qty || 0); // qty = saldo total
  }else{
    const q = Number(asset.qty || 0);
    valueNative = (price===null ? null : q*price);
  }

  // Valor BRL:
  const fx = getFXToBRL(asset.currency);
  const valueBRL = (valueNative===null || fx===null) ? null : valueNative*fx;

  // PnL estimado:
  // - Se avgCost existe e modo não é manual_balance (porque ali já é saldo total)
  // - Para cash (USD) avgCost=1 => PnL ~ 0 em USD; em BRL muda pelo câmbio, mas aqui mantemos simples.
  let pnlBRL = null;
  if(asset.avgCost !== null && asset.avgCost !== undefined && asset.avgCost !== "" && asset.mode!=="manual_balance"){
    const q = Number(asset.qty || 0);
    const avg = Number(asset.avgCost);
    if(Number.isFinite(q) && Number.isFinite(avg) && price !== null && fx !== null){
      const pnlNative = (price - avg) * q;
      pnlBRL = pnlNative * fx;
    }
  }

  return { price, change, valueNative, valueBRL, pnlBRL, fx };
}

/* =========================
   Render
   ========================= */
function render(){
  // FX
  el("fxUSDBRL").textContent = market.fx.USDBRL ? fmtNum(market.fx.USDBRL, 4) : "—";
  el("fxEURBRL").textContent = market.fx.EURBRL ? fmtNum(market.fx.EURBRL, 4) : "—";

  // Tabela
  const filter = (el("filterInput").value || "").trim().toLowerCase();
  const tbody = el("tbody");
  tbody.innerHTML = "";

  let totalBRL = 0;
  let totalPnL = 0;
  let total24h = 0;
  let total24hBase = 0;

  const rows = state.assets.map(a=>{
    const c = computeRow(a);
    return { a, c };
  });

  rows.forEach(({a,c})=>{
    const key = `${a.name} ${a.symbol||""} ${a.account} ${a.category}`.toLowerCase();
    if(filter && !key.includes(filter)) return;

    if(c.valueBRL !== null) totalBRL += c.valueBRL;
    if(c.pnlBRL !== null) totalPnL += c.pnlBRL;

    // 24h (aprox): usa changePct24h aplicado ao valor BRL
    if(c.change !== null && c.valueBRL !== null){
      total24h += c.valueBRL * (c.change/100);
      total24hBase += c.valueBRL;
    }

    const tr = document.createElement("tr");

    const statusDot = (a.mode==="crypto" || a.mode==="stock_b3") ? "green" : (a.mode==="fund_manual" ? "yellow" : "blue");
    const statusText = (a.mode==="crypto" || a.mode==="stock_b3") ? "Automático" : (a.mode==="fund_manual" ? "Preço manual" : "Saldo manual");

    const qtyLabel = (a.mode==="manual_balance") ? "Saldo" : "Qtd";
    const qtyDisplay = (a.mode==="manual_balance") ? fmtMoney(Number(a.qty||0), a.currency) : fmtNum(Number(a.qty||0), 8);

    const priceDisplay = (c.price===null) ? "—" : (
      a.mode==="manual_balance" ? "—" :
      a.mode==="cash" ? fmtMoney(1, a.currency) :
      fmtMoney(c.price, a.currency)
    );

    const valueNativeDisplay = c.valueNative===null ? "—" : fmtMoney(c.valueNative, a.currency);
    const valueBRLDisplay = c.valueBRL===null ? "—" : fmtMoney(c.valueBRL, "BRL");

    const pnlClass = (c.pnlBRL===null) ? "muted" : (c.pnlBRL>=0 ? "pos" : "neg");
    const pnlDisplay = (c.pnlBRL===null) ? "—" : fmtMoney(c.pnlBRL, "BRL");

    const chgClass = (c.change===null) ? "muted" : (c.change>=0 ? "pos" : "neg");
    const chgDisplay = (c.change===null) ? "—" : fmtPct(c.change);

    tr.innerHTML = `
      <td>
        <div style="display:flex;flex-direction:column;gap:3px;">
          <div style="font-weight:700;">
            ${escapeHtml(a.name)} ${a.symbol?`<span class="muted mono">(${escapeHtml(a.symbol)})</span>`:""}
          </div>
          <div class="muted" style="font-size:12px;">
            <span class="mono">${escapeHtml(a.currency)}</span>
            ${a.notes ? ` • ${escapeHtml(a.notes)}` : ""}
          </div>
        </div>
      </td>
      <td class="muted">${escapeHtml(a.category)}</td>
      <td class="muted">${escapeHtml(a.account)}</td>
      <td class="right">
        <span class="muted">${qtyLabel}:</span>
        <span class="mono">${qtyDisplay}</span>
      </td>
      <td class="right mono">${priceDisplay}</td>
      <td class="right mono">${valueNativeDisplay}</td>
      <td class="right mono">${valueBRLDisplay}</td>
      <td class="right mono ${pnlClass}">${pnlDisplay}</td>
      <td class="right mono ${chgClass}">${chgDisplay}</td>
      <td>
        <span class="tag"><span class="dot ${statusDot}"></span>${statusText}</span>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // KPIs
  el("kpiTotalBRL").textContent = fmtMoney(totalBRL, "BRL");

  const pnlEl = el("kpiPnL");
  pnlEl.textContent = (isFinite(totalPnL) && totalPnL!==0) ? fmtMoney(totalPnL, "BRL") : (totalPnL===0 ? fmtMoney(0,"BRL") : "—");
  pnlEl.className = "value mono " + (totalPnL>0 ? "pos" : (totalPnL<0 ? "neg" : ""));

  const pct24h = (total24hBase>0) ? (total24h/total24hBase)*100 : null;
  const k24 = el("kpi24h");
  k24.textContent = (pct24h===null) ? "—" : `${fmtMoney(total24h,"BRL")} (${fmtPct(pct24h)})`;
  k24.className = "value mono " + (pct24h>0 ? "pos" : (pct24h<0 ? "neg" : ""));

  el("kpiTotalSub").textContent =
    `Ativos: ${state.assets.length} • Base: BRL • Auto-refresh: ${state.settings.autoRefreshMinutes} min`;

  // Meta
  el("metaInfo").textContent =
    market.errors.length ? `Avisos: ${market.errors.join(" | ")}` :
    `Fontes: FX Frankfurter • BTC CoinGecko • B3 brapi.dev`;

  // Last updated
  el("lastUpdated").textContent = market.lastUpdated ? new Date(market.lastUpdated).toLocaleString("pt-BR") : "—";
}

/* =========================
   Edit modal simples (prompt)
   ========================= */
async function editQuantities(){
  // fluxo rápido: passa por cada ativo e pede qty e avgCost (opcional) + preços manuais
  for(const a of state.assets){
    const label = (a.mode==="manual_balance") ? "Saldo (valor total)" : "Quantidade";
    const v = prompt(`${a.name} (${a.account})\n${label} em ${a.currency}:`, String(a.qty ?? 0));
    if(v===null) return; // cancel
    const num = Number(v.replace(",", "."));
    if(!Number.isFinite(num)) { toast("Valor inválido. Mantive o anterior."); continue; }
    a.qty = num;

    // preço médio opcional (para calcular ganho/perda simples)
    if(a.mode!=="manual_balance"){
      const ac = prompt(`${a.name}\nPreço médio (opcional) em ${a.currency}.\nDeixe vazio para ignorar PnL.`, (a.avgCost ?? "")==="null" ? "" : String(a.avgCost ?? ""));
      if(ac===null) return;
      const trimmed = String(ac).trim();
      a.avgCost = trimmed==="" ? null : Number(trimmed.replace(",", "."));
      if(a.avgCost !== null && !Number.isFinite(a.avgCost)) a.avgCost = null;
    }

    // fundos manuais: pedir preço por cota
    if(a.mode==="fund_manual"){
      const p = prompt(`${a.name}\nPreço por cota (manual) em EUR:`, String(state.manualPrices[a.id]?.price ?? 0));
      if(p===null) return;
      const pn = Number(String(p).replace(",", "."));
      if(Number.isFinite(pn)) {
        state.manualPrices[a.id] = { price: pn };
      }
    }
  }
  saveState();
  render();
  toast("Quantidades/saldos atualizados.");
}

/* =========================
   Import/Export JSON
   ========================= */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "invest_dashboard_data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async () => {
    const file = inp.files?.[0];
    if(!file) return;
    const txt = await file.text();
    try{
      const parsed = JSON.parse(txt);
      state = {
        ...structuredClone(DEFAULT_DATA),
        ...parsed,
        settings: { ...DEFAULT_DATA.settings, ...(parsed.settings||{}) },
        manualPrices: { ...DEFAULT_DATA.manualPrices, ...(parsed.manualPrices||{}) }
      };
      saveState();
      render();
      toast("Importado com sucesso.");
    }catch{
      toast("Falha ao importar JSON.");
    }
  };
  inp.click();
}

/* =========================
   Refresh
   ========================= */
async function refreshAll(){
  market.errors = [];
  try{
    await fetchFX();
  }catch(e){
    market.errors.push("FX indisponível");
  }

  try{
    await fetchCrypto();
  }catch(e){
    market.errors.push("BTC indisponível");
  }

  try{
    await fetchB3Quotes();
  }catch(e){
    market.errors.push("B3 indisponível");
  }

  market.lastUpdated = Date.now();
  render();
}

/* =========================
   Utils
   ========================= */
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =========================
   Events
   ========================= */
el("refreshBtn").addEventListener("click", async ()=>{
  toast("Atualizando…");
  await refreshAll();
  toast("Atualizado.");
});
el("editBtn").addEventListener("click", editQuantities);
el("exportBtn").addEventListener("click", exportJSON);
el("importBtn").addEventListener("click", importJSON);
el("resetBtn").addEventListener("click", ()=>{
  const ok = confirm("Tem certeza? Isso apaga os dados salvos no navegador.");
  if(!ok) return;
  localStorage.removeItem(STORAGE_KEY);
  state = structuredClone(DEFAULT_DATA);
  saveState();
  render();
  toast("Resetado.");
});
el("filterInput").addEventListener("input", render);

/* =========================
   Boot
   ========================= */
render();
refreshAll();

// Auto-refresh enquanto estiver aberto
setInterval(refreshAll, Math.max(5, Number(state.settings.autoRefreshMinutes||30)) * 60 * 1000);
</script>
</body>
</html>
