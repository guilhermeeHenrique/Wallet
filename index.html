<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard de Investimentos ‚Äî BRL Base</title>
  <style>
    :root{
      --bg:#0a0e13;
      --card:#101826;
      --card2:#0f1622;
      --text:#e8eef7;
      --muted:#9bb0c9;
      --line:#1f2b3a;

      --green:#10b981;
      --red:#ef4444;
      --yellow:#f59e0b;
      --blue:#3b82f6;
      --purple:#a78bfa;
      --pill:#0b1220;

      --shadow: 0 14px 40px rgba(0,0,0,.4);
      --shadow-sm: 0 4px 12px rgba(0,0,0,.3);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* LIGHT THEME */
    [data-theme="light"]{
      --bg:#f8fafc;
      --card:#ffffff;
      --card2:#fafbfc;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --shadow: 0 14px 40px rgba(0,0,0,.08);
      --shadow-sm: 0 4px 12px rgba(0,0,0,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, var(--blue)12, transparent 55%),
        radial-gradient(900px 600px at 90% 20%, var(--green)0a, transparent 60%),
        radial-gradient(900px 600px at 30% 90%, var(--red)08, transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
      font-size:14px;
      line-height:1.6;
      transition: background 0.3s ease, color 0.3s ease;
    }

    header{
      padding:28px 20px 16px;
      max-width:1280px; margin:0 auto;
      display:flex; gap:18px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }

    .title h1{
      margin:0; 
      font-size:28px; 
      letter-spacing:.3px; 
      font-weight:800;
      line-height:1.2;
    }
    .title p{
      margin:10px 0 0; 
      color:var(--muted); 
      font-size:15px; 
      line-height:1.6; 
      max-width:720px;
    }

    .actions{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text);
      padding:12px 18px;
      border-radius:12px;
      cursor:pointer;
      box-shadow: var(--shadow-sm);
      font-size:14px;
      font-weight:600;
      transition: all 0.2s ease;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{
      border-color:rgba(255,255,255,.22);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .btn:active{transform: translateY(0)}
    .btn.primary{
      border:1px solid rgba(59,130,246,.5);
      background:linear-gradient(180deg, rgba(59,130,246,.28), rgba(59,130,246,.14));
      color:#fff;
    }
    .btn.primary:hover{
      border-color:rgba(59,130,246,.7);
      background:linear-gradient(180deg, rgba(59,130,246,.36), rgba(59,130,246,.20));
    }
    .btn.danger{
      border:1px solid rgba(239,68,68,.5);
      background:linear-gradient(180deg, rgba(239,68,68,.28), rgba(239,68,68,.14));
      color:#fff;
    }
    .btn.danger:hover{
      border-color:rgba(239,68,68,.7);
      background:linear-gradient(180deg, rgba(239,68,68,.36), rgba(239,68,68,.20));
    }
    .btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform: none !important;
    }
    .btn.loading::after{
      content:"";
      position:absolute;
      top:50%; left:50%;
      width:14px; height:14px;
      margin:-7px 0 0 -7px;
      border:2px solid transparent;
      border-top-color:currentColor;
      border-radius:50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg)}
    }

    .iconBtn{
      width:36px;
      height:36px;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition: all 0.2s ease;
      color:var(--text);
    }
    .iconBtn:hover{
      background:rgba(255,255,255,.12);
      border-color:rgba(255,255,255,.22);
      transform: translateY(-1px);
    }
    .iconBtn svg{
      width:18px;
      height:18px;
    }

    /* Theme toggle */
    .themeToggle{
      width:52px; height:28px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.16);
      border-radius:999px;
      cursor:pointer;
      position:relative;
      transition: all 0.3s ease;
    }
    .themeToggle::before{
      content:"";
      position:absolute;
      top:2px; left:2px;
      width:22px; height:22px;
      background:#fff;
      border-radius:50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }
    [data-theme="light"] .themeToggle::before{
      left:26px;
      background:#fbbf24;
    }

    main{max-width:1280px; margin:0 auto; padding:12px 20px 40px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:18px;
    }

    .card{
      background:linear-gradient(135deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      overflow:hidden;
      transition: all 0.3s ease;
    }
    .card:hover{
      border-color:rgba(255,255,255,.16);
      transform: translateY(-2px);
      box-shadow: 0 18px 48px rgba(0,0,0,.5);
    }

    /* KPI Cards with icons */
    .kpi{
      grid-column: span 3;
      background:linear-gradient(135deg, rgba(59,130,246,.10), rgba(59,130,246,.03));
      border:1px solid rgba(59,130,246,.25);
      position:relative;
      overflow:hidden;
    }
    .kpi::before{
      content:"";
      position:absolute;
      top:-50%; right:-20%;
      width:140%;
      height:200%;
      background:radial-gradient(circle, rgba(255,255,255,.04) 0%, transparent 70%);
      pointer-events:none;
    }
    .kpi:nth-child(2){
      background:linear-gradient(135deg, rgba(16,185,129,.10), rgba(16,185,129,.03));
      border-color:rgba(16,185,129,.25);
    }
    .kpi:nth-child(3){
      background:linear-gradient(135deg, rgba(168,85,247,.10), rgba(168,85,247,.03));
      border-color:rgba(168,85,247,.25);
    }
    .kpi:nth-child(4){
      background:linear-gradient(135deg, rgba(245,158,11,.10), rgba(245,158,11,.03));
      border-color:rgba(245,158,11,.25);
    }

    @media (max-width: 1100px){ .kpi{grid-column: span 6;} }
    @media (max-width: 600px){ .kpi{grid-column: span 12;} }

    .kpi .kpiHeader{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }
    .kpi .icon{
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(255,255,255,.08);
      border-radius:10px;
      flex-shrink:0;
    }
    .kpi .icon svg{
      width:22px;
      height:22px;
      opacity:0.9;
    }
    .kpi .label{
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.8px;
    }
    .kpi .value{
      margin-top:6px;
      font-size:28px;
      font-weight:800;
      letter-spacing:.3px;
      line-height:1.2;
    }
    .kpi .sub{
      margin-top:12px;
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
    }

    /* System Status */
    .systemStatus{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 16px;
      border-radius:12px;
      background:rgba(0,0,0,.2);
      border:1px solid rgba(255,255,255,.1);
      font-size:13px;
      font-weight:600;
    }
    .statusDot{
      width:8px;
      height:8px;
      border-radius:50%;
      animation: pulse 2s ease-in-out infinite;
    }
    .statusDot.ok{background:var(--green)}
    .statusDot.warn{background:var(--yellow)}
    .statusDot.error{background:var(--red)}
    @keyframes pulse{
      0%, 100%{opacity:1}
      50%{opacity:0.5}
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 16px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-size:13px;
      font-weight:600;
    }
    .pill strong{color:var(--text); font-family:var(--mono); font-weight:700}

    .tableCard{grid-column: span 12; padding:0}
    .tableHeader{
      padding:20px 24px;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .tableHeader h2{
      margin:0; 
      font-size:20px; 
      font-weight:800; 
      letter-spacing:.4px;
    }
    .tableHeader .meta{
      color:var(--muted); 
      font-size:14px; 
      margin-top:6px;
    }
    
    .tableWrap{overflow:auto; position:relative}
    table{width:100%; border-collapse:collapse; min-width:1200px}
    thead{
      position:sticky;
      top:0;
      z-index:10;
      background:var(--card);
    }
    th, td{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
      font-size:14px;
      white-space:nowrap;
    }
    th{
      color:var(--muted);
      font-weight:700;
      text-align:left;
      background:rgba(255,255,255,.04);
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:0.8px;
    }
    tbody tr{
      transition: background 0.15s ease;
      cursor:pointer;
    }
    tbody tr:hover td{
      background:rgba(59,130,246,.08);
    }

    /* Mobile card view */
    .assetCard{
      display:none;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.1);
      border-radius:14px;
      padding:18px;
      margin-bottom:14px;
      cursor:pointer;
      transition: all 0.2s ease;
    }
    .assetCard:hover{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.16);
    }
    .assetCard .cardRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .assetCard .cardRow:last-child{
      margin-bottom:0;
      padding-bottom:0;
      border-bottom:none;
    }
    .assetCard .cardLabel{
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.6px;
    }
    .assetCard .cardValue{
      font-family:var(--mono);
      font-weight:700;
      font-size:15px;
    }

    @media (max-width: 768px){
      .compactView .tableWrap table{display:none}
      .compactView .assetCard{display:block}
    }

    .right{text-align:right}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .pos{color:var(--green); font-weight:700}
    .neg{color:var(--red); font-weight:700}
    .warn{color:var(--yellow); font-weight:700}
    
    .tag{
      display:inline-flex; align-items:center;
      padding:7px 13px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      gap:8px;
    }
    .dot{width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.25)}
    .dot.green{background:var(--green)}
    .dot.red{background:var(--red)}
    .dot.blue{background:var(--blue)}
    .dot.yellow{background:var(--yellow)}

    .inlineInputs{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    input[type="number"], input[type="text"], input[type="date"], select, textarea{
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:11px 15px;
      color:var(--text);
      font-size:14px;
      outline:none;
      width:200px;
      transition: all 0.2s ease;
      font-weight:500;
      font-family:var(--sans);
    }
    textarea{
      resize:vertical;
      min-height:80px;
      line-height:1.5;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(59,130,246,.6);
      background:rgba(0,0,0,.35);
    }
    input[type="text"]{width:260px}
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .small{width:160px !important}

    label{
      display:block;
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.6px;
      margin-bottom:8px;
    }

    .formGroup{
      margin-bottom:20px;
    }

    .footerNote{
      margin-top:14px;
      color:var(--muted);
      font-size:14px;
      line-height:1.6;
    }

    .toast{
      position:fixed; bottom:24px; right:24px;
      background:rgba(16,24,38,.98);
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:16px 20px;
      box-shadow: 0 12px 32px rgba(0,0,0,.6);
      color:var(--text);
      font-size:14px;
      font-weight:600;
      display:none;
      max-width:420px;
      z-index:9999;
      animation: slideIn 0.3s ease;
    }
    .toast.show{display:block}
    .toast.success{
      border-color:rgba(16,185,129,.5);
      background:rgba(16,185,129,.15);
    }
    .toast.error{
      border-color:rgba(239,68,68,.5);
      background:rgba(239,68,68,.15);
    }
    @keyframes slideIn{
      from{transform:translateX(400px); opacity:0}
      to{transform:translateX(0); opacity:1}
    }

    /* MODAL */
    .modal{
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,.75);
      z-index:10000;
      align-items:center;
      justify-content:center;
      padding:20px;
      animation: fadeIn 0.2s ease;
    }
    .modal.show{display:flex}
    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }

    .modalContent{
      background:var(--card);
      border:1px solid rgba(255,255,255,.15);
      border-radius:18px;
      box-shadow: 0 24px 64px rgba(0,0,0,.7);
      max-width:540px;
      width:100%;
      max-height:90vh;
      overflow:auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp{
      from{transform:translateY(40px); opacity:0}
      to{transform:translateY(0); opacity:1}
    }

    .modalHeader{
      padding:24px 28px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modalHeader h3{
      margin:0;
      font-size:22px;
      font-weight:800;
      letter-spacing:.3px;
    }
    .modalClose{
      width:32px;
      height:32px;
      padding:0;
      border:none;
      background:rgba(255,255,255,.08);
      border-radius:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: all 0.2s ease;
      color:var(--text);
    }
    .modalClose:hover{
      background:rgba(255,255,255,.15);
    }
    .modalClose svg{
      width:18px;
      height:18px;
    }

    .modalBody{
      padding:28px;
    }

    .modalFooter{
      padding:20px 28px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:12px;
      justify-content:flex-end;
    }

    /* HIST√ìRICO */
    .historyCard{grid-column: span 12; padding:0}
    .historyTabs{
      padding:20px 24px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .tabGroup{
      display:flex;
      gap:8px;
      background:rgba(0,0,0,.3);
      padding:4px;
      border-radius:12px;
    }
    .tabBtn{
      padding:10px 18px;
      border:none;
      background:transparent;
      color:var(--muted);
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      transition: all 0.2s ease;
    }
    .tabBtn:hover{
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
    .tabBtn.active{
      background:rgba(59,130,246,.2);
      color:#fff;
    }

    .historyGrid{
      display:grid;
      grid-template-columns: 1.4fr .6fr;
      gap:18px;
      padding:24px;
    }
    @media (max-width: 1024px){
      .historyGrid{grid-template-columns: 1fr;}
    }

    .canvasWrap{
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.1);
      border-radius:var(--radius2);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .rangeSelector{
      display:flex;
      gap:8px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .rangeBtn{
      padding:9px 16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      border-radius:8px;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      transition: all 0.2s ease;
    }
    .rangeBtn:hover{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.2);
    }
    .rangeBtn.active{
      background:rgba(59,130,246,.22);
      border-color:rgba(59,130,246,.4);
      color:#fff;
    }

    canvas{width:100%; height:300px; display:block; cursor:crosshair}
    
    .chartTooltip{
      position:absolute;
      background:rgba(16,24,38,.98);
      border:1px solid rgba(255,255,255,.2);
      border-radius:10px;
      padding:12px 16px;
      font-size:13px;
      pointer-events:none;
      display:none;
      z-index:100;
      box-shadow: 0 8px 24px rgba(0,0,0,.5);
      font-weight:600;
    }
    .chartTooltip.show{display:block}

    .miniTable{
      width:100%;
      border-collapse:collapse;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.1);
      border-radius:var(--radius2);
      overflow:hidden;
    }
    .miniTable th, .miniTable td{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:14px;
      white-space:nowrap;
    }
    .miniTable th{
      background:rgba(255,255,255,.04);
      color:var(--muted);
      text-align:left;
      font-weight:700;
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:0.8px;
    }
    .miniTable tr:last-child td{border-bottom:none;}
    .miniTable tbody tr:hover{
      background:rgba(255,255,255,.04);
    }

    .assetHistoryActions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:20px;
    }

    @media (max-width: 600px){
      header{padding:22px 16px 14px}
      main{padding:10px 16px 28px}
      .grid{gap:14px}
      .card{padding:16px}
      .kpi .value{font-size:24px}
      .tableHeader{padding:16px 18px}
      .historyGrid{padding:18px}
      .title h1{font-size:24px}
    }
  </style>
</head>
<body data-theme="dark">
<header>
  <div class="title">
    <h1>Dashboard de Investimentos</h1>
    <p>
      Acompanhe seu portf√≥lio com cota√ß√µes autom√°ticas (FX, BTC, B3). Atualize quantidades/saldos quando quiser.
      <br><span class="muted">Verde = ganho ‚Ä¢ Vermelho = perda ‚Ä¢ Valores em moeda original e BRL</span>
    </p>
  </div>

  <div class="actions">
    <div class="themeToggle" id="themeToggle" title="Alternar tema"></div>
    <div class="systemStatus" id="systemStatus">
      <span class="statusDot ok" id="statusDot"></span>
      <span id="statusText">Sistemas OK</span>
    </div>
    <span class="pill">Atualizado: <strong id="lastUpdated">‚Äî</strong></span>
    <button class="btn primary" id="refreshBtn">Atualizar agora</button>
    <button class="btn" id="editBtn">Editar quantidades</button>
    <button class="btn danger" id="resetBtn">Resetar dados</button>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card kpi">
      <div class="kpiHeader">
        <div class="icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div class="label">Patrim√¥nio Total</div>
      </div>
      <div class="value mono" id="kpiTotalBRL">‚Äî</div>
      <div class="sub" id="kpiTotalSub">‚Äî</div>
    </div>

    <div class="card kpi">
      <div class="kpiHeader">
        <div class="icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
        </div>
        <div class="label">Ganho/Perda</div>
      </div>
      <div class="value mono" id="kpiPnL">‚Äî</div>
      <div class="sub muted">Baseado em pre√ßo atual vs m√©dio</div>
    </div>

    <div class="card kpi">
      <div class="kpiHeader">
        <div class="icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
        </div>
        <div class="label">Varia√ß√£o 24h</div>
      </div>
      <div class="value mono" id="kpi24h">‚Äî</div>
      <div class="sub muted">Para ativos com cota√ß√£o (BTC e B3)</div>
    </div>

    <div class="card kpi">
      <div class="kpiHeader">
        <div class="icon">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>
        </div>
        <div class="label">C√¢mbio</div>
      </div>
      <div class="value" style="display:flex; gap:12px; flex-wrap:wrap;">
        <span class="tag"><span class="dot blue"></span><span>USD/BRL</span> <span class="mono" id="fxUSDBRL">‚Äî</span></span>
        <span class="tag"><span class="dot yellow"></span><span>EUR/BRL</span> <span class="mono" id="fxEURBRL">‚Äî</span></span>
      </div>
      <div class="sub muted">Taxas via Frankfurter (ECB)</div>
    </div>

    <div class="card tableCard">
      <div class="tableHeader">
        <div>
          <h2>Carteira ‚Äî Vis√£o Consolidada</h2>
          <div class="meta" id="metaInfo">‚Äî</div>
        </div>
        <div class="inlineInputs">
          <input type="text" id="filterInput" placeholder="Filtrar (ex: VALE3, BTC)" />
          <button class="btn" id="compactToggle" style="display:none">üì± Modo compacto</button>
          <button class="btn" id="exportBtn">Exportar JSON</button>
          <button class="btn" id="importBtn">Importar JSON</button>
        </div>
      </div>

      <div class="tableWrap" id="tableWrap">
        <table>
          <thead>
            <tr>
              <th>Ativo</th>
              <th>Categoria</th>
              <th>Conta</th>
              <th class="right">Quantidade / Saldo</th>
              <th class="right">Pre√ßo atual</th>
              <th class="right">Valor (moeda)</th>
              <th class="right">Valor (BRL)</th>
              <th class="right">G/P (BRL)</th>
              <th class="right">24h</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="mobileCards"></div>
      </div>

      <div class="tableHeader" style="border-top:1px solid rgba(255,255,255,.08); border-bottom:none;">
        <div class="footerNote">
          <b>Notas:</b><br/>
          1) Clique em qualquer linha para ver o hist√≥rico do ativo ou use o bot√£o "Editar" para modificar dados.<br/>
          2) "Pre√ßo atual" √© autom√°tico para BTC (CoinGecko) e a√ß√µes B3 (brapi). Fundos/renda fixa s√£o manuais.<br/>
          3) Ferramenta de acompanhamento. N√£o √© recomenda√ß√£o de investimento.
        </div>
      </div>
    </div>

    <div class="card historyCard">
      <div class="historyTabs">
        <div>
          <div class="tabGroup">
            <button class="tabBtn active" id="tabPortfolio">üìä Hist√≥rico da Carteira</button>
            <button class="tabBtn" id="tabAsset" style="display:none">üìà Hist√≥rico do Ativo</button>
          </div>
          <div class="meta" id="historyMeta" style="margin-top:8px">Salve snapshots mensais e acompanhe crescimento</div>
        </div>
        <div class="inlineInputs" id="portfolioHistoryControls">
          <input type="date" id="snapDate" />
          <input type="text" id="snapNote" placeholder="Nota (opcional)" class="small" />
          <button class="btn primary" id="saveSnapshotBtn">Salvar snapshot</button>
          <button class="btn" id="manageHistoryBtn">Gerenciar</button>
          <button class="btn danger" id="deleteLastSnapshotBtn">Apagar √∫ltimo</button>
        </div>
        <div class="inlineInputs" id="assetHistoryControls" style="display:none">
          <button class="btn" id="closeAssetHistoryBtn">‚Üê Voltar para Carteira</button>
          <button class="btn primary" id="addAssetHistoryBtn">Adicionar entrada</button>
          <button class="btn" id="manageAssetHistoryBtn">Gerenciar</button>
        </div>
      </div>

      <div class="historyGrid" id="portfolioHistoryView">
        <div class="canvasWrap">
          <div class="rangeSelector">
            <button class="rangeBtn active" data-range="all">Tudo</button>
            <button class="rangeBtn" data-range="12">1 ano</button>
            <button class="rangeBtn" data-range="6">6 meses</button>
          </div>
          <canvas id="historyChart" width="1200" height="400"></canvas>
          <div class="chartTooltip" id="chartTooltip"></div>
          <div class="footerNote" id="historySummary">‚Äî</div>
        </div>

        <div style="display:flex; flex-direction:column; gap:16px;">
          <table class="miniTable">
            <thead>
              <tr>
                <th>Data</th>
                <th class="right">Total (BRL)</th>
                <th class="right">Œî (R$)</th>
                <th class="right">Œî (%)</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
          <div class="footerNote muted">
            üí° Dica: Fa√ßa snapshots mensais. Para hist√≥rico antigo (2021/2022‚Ä¶), adicione manualmente em "Gerenciar".
          </div>
        </div>
      </div>

      <div class="historyGrid" id="assetHistoryView" style="display:none">
        <div class="canvasWrap">
          <div class="rangeSelector">
            <button class="rangeBtn active assetRangeBtn" data-range="all">Tudo</button>
            <button class="rangeBtn assetRangeBtn" data-range="12">1 ano</button>
            <button class="rangeBtn assetRangeBtn" data-range="6">6 meses</button>
          </div>
          <canvas id="assetHistoryChart" width="1200" height="400"></canvas>
          <div class="chartTooltip" id="assetChartTooltip"></div>
          <div class="footerNote" id="assetHistorySummary">‚Äî</div>
        </div>

        <div style="display:flex; flex-direction:column; gap:16px;">
          <table class="miniTable">
            <thead>
              <tr>
                <th>Data</th>
                <th class="right">Qtd/Saldo</th>
                <th class="right">Valor (BRL)</th>
                <th class="right">Œî (%)</th>
              </tr>
            </thead>
            <tbody id="assetHistoryTbody"></tbody>
          </table>
          <div class="footerNote muted">
            üí° Registre valores hist√≥ricos do ativo para acompanhar evolu√ß√£o ao longo do tempo.
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<!-- Edit Asset Modal -->
<div class="modal" id="editAssetModal">
  <div class="modalContent">
    <div class="modalHeader">
      <h3 id="editAssetTitle">Editar Ativo</h3>
      <button class="modalClose" id="closeEditModal">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="modalBody">
      <div class="formGroup">
        <label id="qtyLabel">Quantidade</label>
        <input type="number" id="editQty" step="0.00000001" />
      </div>
      <div class="formGroup" id="avgCostGroup">
        <label>Pre√ßo M√©dio (opcional)</label>
        <input type="number" id="editAvgCost" step="0.01" placeholder="Deixe vazio para ignorar G/P" />
        <div style="color:var(--muted); font-size:12px; margin-top:6px;">Usado para calcular ganho/perda</div>
      </div>
      <div class="formGroup" id="manualPriceGroup" style="display:none">
        <label>Pre√ßo Manual (EUR)</label>
        <input type="number" id="editManualPrice" step="0.01" />
        <div style="color:var(--muted); font-size:12px; margin-top:6px;">Pre√ßo atual da cota/unidade</div>
      </div>
      <div class="formGroup">
        <label>Notas</label>
        <textarea id="editNotes" placeholder="Observa√ß√µes sobre este ativo..."></textarea>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="cancelEditBtn">Cancelar</button>
      <button class="btn primary" id="saveEditBtn">Salvar</button>
    </div>
  </div>
</div>

<!-- Add Asset History Modal -->
<div class="modal" id="addAssetHistoryModal">
  <div class="modalContent">
    <div class="modalHeader">
      <h3>Adicionar Entrada de Hist√≥rico</h3>
      <button class="modalClose" id="closeAssetHistoryModal">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="modalBody">
      <div class="formGroup">
        <label>Data</label>
        <input type="date" id="assetHistoryDate" />
      </div>
      <div class="formGroup">
        <label id="assetHistoryQtyLabel">Quantidade</label>
        <input type="number" id="assetHistoryQty" step="0.00000001" />
      </div>
      <div class="formGroup">
        <label>Valor em BRL (opcional)</label>
        <input type="number" id="assetHistoryValue" step="0.01" placeholder="Calculado automaticamente se vazio" />
        <div style="color:var(--muted); font-size:12px; margin-top:6px;">Se vazio, ser√° calculado com base no pre√ßo atual</div>
      </div>
      <div class="formGroup">
        <label>Nota</label>
        <input type="text" id="assetHistoryNote" placeholder="Observa√ß√£o (opcional)" />
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn" id="cancelAssetHistoryBtn">Cancelar</button>
      <button class="btn primary" id="saveAssetHistoryBtn">Salvar</button>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Investment Dashboard - Professional Edition
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const STORAGE_KEY = "inv_dashboard_v1";
const THEME_KEY = "inv_dashboard_theme";
const CACHE_KEY = "inv_dashboard_cache";

let cache = {
  fx: { data: null, expires: 0 },
  btc: { data: null, expires: 0 },
  b3: { data: null, expires: 0 }
};

const DEFAULT_DATA = {
  settings: {
    baseCurrency: "BRL",
    autoRefreshMinutes: 30
  },
  assets: [
    { id:"btc", name:"Bitcoin", category:"Cripto", account:"BINANCE", currency:"USD", mode:"crypto", coingeckoId:"bitcoin", qty:0.0, avgCost:null, notes:"Qtd em BTC; pre√ßo em USD", history:[] },
    { id:"usd_cash", name:"D√≥lar em conta", category:"Caixa", account:"BINANCE", currency:"USD", mode:"cash", qty:0.0, avgCost:1.0, notes:"Saldo em USD", history:[] },
    { id:"td_selic_2026", name:"Tesouro Selic 2026", category:"Renda fixa", account:"C6", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)", history:[] },
    { id:"td_selic_2027", name:"Tesouro Selic 2027", category:"Renda fixa", account:"C6", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)", history:[] },
    { id:"td_selic_2029", name:"Tesouro Selic 2029", category:"Renda fixa", account:"C6", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)", history:[] },
    { id:"nubank_caixinha", name:"Caixinha Nubank (120% CDI)", category:"Renda fixa", account:"NUBANK", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)", history:[] },
    { id:"nu_reserva", name:"Nu Reserva Imediata", category:"Fundo", account:"NUBANK", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)", history:[] },
    { id:"mp_cofrinho", name:"Cofrinho Mercado Pago (120% CDI)", category:"Renda fixa", account:"Mercado Pago", currency:"BRL", mode:"manual_balance", qty:0.0, avgCost:null, notes:"Saldo atual (manual)", history:[] },
    { id:"ggbr4", name:"Gerdau", category:"A√ß√µes B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"GGBR4", qty:0.0, avgCost:null, notes:"Qtd de a√ß√µes", history:[] },
    { id:"vale3", name:"Vale", category:"A√ß√µes B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"VALE3", qty:0.0, avgCost:null, notes:"Qtd de a√ß√µes", history:[] },
    { id:"cmig4", name:"Cemig", category:"A√ß√µes B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"CMIG4", qty:0.0, avgCost:null, notes:"Qtd de a√ß√µes", history:[] },
    { id:"tasa4", name:"Taurus", category:"A√ß√µes B3", account:"Inter", currency:"BRL", mode:"stock_b3", symbol:"TASA4", qty:0.0, avgCost:null, notes:"Qtd de a√ß√µes", history:[] },
    { id:"wise_ishares_world", name:"iShares World Equity Index Fund", category:"Fundo", account:"WISE", currency:"EUR", mode:"fund_manual", qty:0.0, avgCost:null, notes:"Qtd (cotas) + pre√ßo manual em EUR", history:[] }
  ],
  manualPrices: {
    "wise_ishares_world": { price: 0.0 }
  },
  history: []
};

let state = loadState();
let market = {
  fx: { USDBRL: null, EURBRL: null },
  quotes: {},
  lastUpdated: null,
  errors: [],
  status: { fx: 'ok', btc: 'ok', b3: 'ok' }
};

let chartRange = 'all';
let assetChartRange = 'all';
let isCompactView = false;
let currentEditAsset = null;
let currentViewAsset = null;

const el = (id) => document.getElementById(id);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Storage & State Management
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return structuredClone(DEFAULT_DATA);
  try{
    const parsed = JSON.parse(raw);
    // Ensure all assets have history array
    if(parsed.assets){
      parsed.assets.forEach(a => {
        if(!a.history) a.history = [];
      });
    }
    return {
      ...structuredClone(DEFAULT_DATA),
      ...parsed,
      settings: { ...DEFAULT_DATA.settings, ...(parsed.settings||{}) },
      manualPrices: { ...DEFAULT_DATA.manualPrices, ...(parsed.manualPrices||{}) },
      history: Array.isArray(parsed.history) ? parsed.history : [],
      assets: parsed.assets || DEFAULT_DATA.assets
    };
  }catch{
    return structuredClone(DEFAULT_DATA);
  }
}

function loadCache(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(raw) cache = JSON.parse(raw);
  }catch{}
}

function saveCache(){
  try{
    localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
  }catch{}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Formatting Utilities
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmtMoney(v, cur="BRL"){
  if(v === null || v === undefined || Number.isNaN(v)) return "‚Äî";
  return new Intl.NumberFormat("pt-BR", { style:"currency", currency:cur, maximumFractionDigits: 2 }).format(v);
}

function fmtNum(v, max=6){
  if(v === null || v === undefined || Number.isNaN(v)) return "‚Äî";
  return new Intl.NumberFormat("pt-BR", { maximumFractionDigits: max }).format(v);
}

function fmtPct(v){
  if(v === null || v === undefined || Number.isNaN(v)) return "‚Äî";
  const sign = v > 0 ? "+" : "";
  return sign + v.toFixed(2) + "%";
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function toast(msg, type='info'){
  const t = el("toast");
  t.textContent = msg;
  t.className = "toast show " + type;
  setTimeout(()=>t.classList.remove("show"), 3200);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Network - fetchWithTimeout + Retry
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function fetchWithTimeout(url, timeout=8000){
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try{
    const response = await fetch(url, { signal: controller.signal });
    clearTimeout(id);
    return response;
  }catch(e){
    clearTimeout(id);
    throw e;
  }
}

async function fetchWithRetry(url, maxRetries=1, timeout=8000){
  for(let i=0; i<=maxRetries; i++){
    try{
      const res = await fetchWithTimeout(url, timeout);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }catch(e){
      if(i === maxRetries) throw e;
      await new Promise(r => setTimeout(r, 1000));
    }
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   API Fetchers with Caching
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function fetchFX(){
  const now = Date.now();
  const TTL = 10 * 60 * 1000;

  if(cache.fx.data && cache.fx.expires > now){
    market.fx = cache.fx.data;
    market.status.fx = 'ok';
    return;
  }

  try{
    const [a, b] = await Promise.all([
      fetchWithRetry("https://api.frankfurter.dev/latest?from=EUR&to=BRL", 1),
      fetchWithRetry("https://api.frankfurter.dev/latest?from=USD&to=BRL", 1)
    ]);

    market.fx.EURBRL = a?.rates?.BRL ?? null;
    market.fx.USDBRL = b?.rates?.BRL ?? null;
    market.status.fx = 'ok';

    cache.fx = { data: {...market.fx}, expires: now + TTL };
    saveCache();
  }catch(e){
    market.status.fx = 'error';
    market.errors.push("FX indispon√≠vel");
    if(cache.fx.data){
      market.fx = cache.fx.data;
      market.status.fx = 'warn';
    }
  }
}

async function fetchCrypto(){
  const now = Date.now();
  const TTL = 2 * 60 * 1000;

  const ids = state.assets.filter(x=>x.mode==="crypto").map(x=>x.coingeckoId).filter(Boolean);
  if(ids.length===0) return;

  if(cache.btc.data && cache.btc.expires > now){
    Object.assign(market.quotes, cache.btc.data);
    market.status.btc = 'ok';
    return;
  }

  try{
    const url = "https://api.coingecko.com/api/v3/simple/price?ids=" + 
                encodeURIComponent(ids.join(",")) + 
                "&vs_currencies=usd&include_24hr_change=true";
    const data = await fetchWithRetry(url, 1);

    const quotes = {};
    for(const a of state.assets.filter(x=>x.mode==="crypto")){
      const d = data[a.coingeckoId];
      if(!d) continue;
      quotes[a.id] = {
        price: d.usd ?? null,
        changePct24h: d.usd_24h_change ?? null,
        currency: "USD"
      };
      market.quotes[a.id] = quotes[a.id];
    }

    market.status.btc = 'ok';
    cache.btc = { data: quotes, expires: now + TTL };
    saveCache();
  }catch(e){
    market.status.btc = 'error';
    market.errors.push("BTC indispon√≠vel");
    if(cache.btc.data){
      Object.assign(market.quotes, cache.btc.data);
      market.status.btc = 'warn';
    }
  }
}

async function fetchB3Quotes(){
  const now = Date.now();
  const TTL = 2 * 60 * 1000;

  const syms = state.assets.filter(x=>x.mode==="stock_b3").map(x=>x.symbol).filter(Boolean);
  if(syms.length===0) return;

  if(cache.b3.data && cache.b3.expires > now){
    Object.assign(market.quotes, cache.b3.data);
    market.status.b3 = 'ok';
    return;
  }

  try{
    const tasks = syms.map(sym =>
      fetchWithRetry(`https://brapi.dev/api/quote/${encodeURIComponent(sym)}`, 1)
        .then(j=>({sym,j}))
    );

    const results = await Promise.allSettled(tasks);
    const quotes = {};

    results.forEach((item, idx)=>{
      const sym = syms[idx];
      if(item.status!=="fulfilled") return;
      const q = item.value.j?.results?.[0];
      if(!q) return;

      const price = q.regularMarketPrice ?? null;
      const chg = q.regularMarketChangePercent ?? null;

      const asset = state.assets.find(a=>a.mode==="stock_b3" && a.symbol===sym);
      if(!asset) return;

      quotes[asset.id] = { price, changePct24h: chg, currency: "BRL" };
      market.quotes[asset.id] = quotes[asset.id];
    });

    market.status.b3 = 'ok';
    cache.b3 = { data: quotes, expires: now + TTL };
    saveCache();
  }catch(e){
    market.status.b3 = 'error';
    market.errors.push("B3 indispon√≠vel");
    if(cache.b3.data){
      Object.assign(market.quotes, cache.b3.data);
      market.status.b3 = 'warn';
    }
  }
}

function getFXToBRL(currency){
  if(currency==="BRL") return 1.0;
  if(currency==="USD") return market.fx.USDBRL;
  if(currency==="EUR") return market.fx.EURBRL;
  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Calculations
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function computeRow(asset){
  let price = null;
  let change = null;

  if(asset.mode==="crypto" || asset.mode==="stock_b3"){
    price = market.quotes[asset.id]?.price ?? null;
    change = market.quotes[asset.id]?.changePct24h ?? null;
  }else if(asset.mode==="fund_manual"){
    price = state.manualPrices?.[asset.id]?.price ?? null;
  }else if(asset.mode==="cash"){
    price = 1.0;
  }else if(asset.mode==="manual_balance"){
    price = 1.0;
  }

  let valueNative = null;
  if(asset.mode==="manual_balance"){
    valueNative = Number(asset.qty || 0);
  }else{
    const q = Number(asset.qty || 0);
    valueNative = (price===null ? null : q*price);
  }

  const fx = getFXToBRL(asset.currency);
  const valueBRL = (valueNative===null || fx===null) ? null : valueNative*fx;

  let pnlBRL = null;
  if(asset.avgCost !== null && asset.avgCost !== undefined && asset.avgCost !== "" && asset.mode!=="manual_balance"){
    const q = Number(asset.qty || 0);
    const avg = Number(asset.avgCost);
    if(Number.isFinite(q) && Number.isFinite(avg) && price !== null && fx !== null){
      const pnlNative = (price - avg) * q;
      pnlBRL = pnlNative * fx;
    }
  }

  return { price, change, valueNative, valueBRL, pnlBRL, fx };
}

function computeTotalBRL(){
  let total = 0;
  for(const a of state.assets){
    const c = computeRow(a);
    if(c.valueBRL !== null && Number.isFinite(c.valueBRL)) total += c.valueBRL;
  }
  return total;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Portfolio History Management
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function normalizeDate(yyyy_mm_dd){
  if(!yyyy_mm_dd) return null;
  const s = String(yyyy_mm_dd).trim();
  if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
  return s;
}

function sortHistory(){
  state.history.sort((x,y)=> (x.date||"").localeCompare(y.date||""));
}

function upsertSnapshot(date, totalBRL, note=""){
  const d = normalizeDate(date);
  if(!d) { toast("Data inv√°lida.", 'error'); return false; }
  if(!Number.isFinite(totalBRL) || Number.isNaN(totalBRL)) {
    toast("Valor inv√°lido.", 'error');
    return false;
  }

  const idx = state.history.findIndex(h=>h.date===d);
  const snap = { date:d, totalBRL:Number(totalBRL), note:String(note||"").trim() };

  if(idx>=0) state.history[idx] = snap;
  else state.history.push(snap);

  sortHistory();
  saveState();
  return true;
}

function deleteLastSnapshot(){
  if(state.history.length===0) return;
  sortHistory();
  state.history.pop();
  saveState();
}

function getFilteredHistory(){
  sortHistory();
  const h = state.history;
  if(chartRange === 'all') return h;

  const months = parseInt(chartRange);
  if(!months) return h;

  const cutoff = new Date();
  cutoff.setMonth(cutoff.getMonth() - months);
  const cutoffStr = cutoff.toISOString().slice(0,10);

  return h.filter(snap => snap.date >= cutoffStr);
}

function manageHistory(){
  sortHistory();
  const current = state.history.map(h=>`${h.date} | ${h.totalBRL} | ${h.note||""}`).join("\n") || "(vazio)";
  const msg =
`Cole/edite aqui sua lista de snapshots (um por linha):
YYYY-MM-DD | 12345.67 | nota opcional

Exemplo:
2021-12-31 | 3500.00 | in√≠cio
2022-12-31 | 12000.00 | fim do ano

Use ponto no decimal (.)`;

  const edited = prompt(msg + "\n\nConte√∫do atual:\n" + current, current);
  if(edited===null) return;

  const lines = String(edited).split("\n").map(l=>l.trim()).filter(Boolean);
  const newHist = [];
  for(const line of lines){
    if(line==="(vazio)") continue;
    const parts = line.split("|").map(p=>p.trim());
    const d = normalizeDate(parts[0]);
    const v = Number((parts[1]||"").replace(",", "."));
    const note = parts.slice(2).join(" | ").trim();
    if(!d || !Number.isFinite(v)) continue;
    newHist.push({ date:d, totalBRL:v, note });
  }
  state.history = newHist;
  sortHistory();
  saveState();
  renderHistory();
  toast("Hist√≥rico atualizado.", 'success');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Asset History Management
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sortAssetHistory(asset){
  if(!asset.history) asset.history = [];
  asset.history.sort((x,y)=> (x.date||"").localeCompare(y.date||""));
}

function upsertAssetHistory(asset, date, qty, valueBRL, note=""){
  const d = normalizeDate(date);
  if(!d) { toast("Data inv√°lida.", 'error'); return false; }
  if(!Number.isFinite(qty) || Number.isNaN(qty)) {
    toast("Quantidade inv√°lida.", 'error');
    return false;
  }

  if(!asset.history) asset.history = [];

  const idx = asset.history.findIndex(h=>h.date===d);
  const entry = { 
    date:d, 
    qty:Number(qty), 
    valueBRL: valueBRL !== null && Number.isFinite(valueBRL) ? Number(valueBRL) : null,
    note:String(note||"").trim() 
  };

  if(idx>=0) asset.history[idx] = entry;
  else asset.history.push(entry);

  sortAssetHistory(asset);
  saveState();
  return true;
}

function getFilteredAssetHistory(asset){
  if(!asset.history) asset.history = [];
  sortAssetHistory(asset);
  const h = asset.history;
  if(assetChartRange === 'all') return h;

  const months = parseInt(assetChartRange);
  if(!months) return h;

  const cutoff = new Date();
  cutoff.setMonth(cutoff.getMonth() - months);
  const cutoffStr = cutoff.toISOString().slice(0,10);

  return h.filter(snap => snap.date >= cutoffStr);
}

function manageAssetHistory(asset){
  sortAssetHistory(asset);
  const current = asset.history.map(h=>`${h.date} | ${h.qty} | ${h.valueBRL||""} | ${h.note||""}`).join("\n") || "(vazio)";
  const msg =
`Cole/edite o hist√≥rico do ativo (um por linha):
YYYY-MM-DD | quantidade | valorBRL | nota opcional

Exemplo:
2021-12-31 | 100 | 5000.00 | compra inicial
2022-12-31 | 150 | 9000.00 | aporte

Use ponto no decimal (.)`;

  const edited = prompt(msg + "\n\nConte√∫do atual:\n" + current, current);
  if(edited===null) return;

  const lines = String(edited).split("\n").map(l=>l.trim()).filter(Boolean);
  const newHist = [];
  for(const line of lines){
    if(line==="(vazio)") continue;
    const parts = line.split("|").map(p=>p.trim());
    const d = normalizeDate(parts[0]);
    const q = Number((parts[1]||"").replace(",", "."));
    const v = parts[2] ? Number((parts[2]||"").replace(",", ".")) : null;
    const note = parts.slice(3).join(" | ").trim();
    if(!d || !Number.isFinite(q)) continue;
    newHist.push({ date:d, qty:q, valueBRL:v, note });
  }
  asset.history = newHist;
  sortAssetHistory(asset);
  saveState();
  renderAssetHistory();
  toast("Hist√≥rico do ativo atualizado.", 'success');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Chart Rendering
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function drawHistoryChart(history){
  const canvas = el("historyChart");
  const ctx = canvas.getContext("2d");

  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const cssW = rect.width || 800;
  const cssH = rect.height || 300;

  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.scale(dpr, dpr);

  ctx.clearRect(0,0,cssW,cssH);

  if(!history || history.length<2){
    ctx.fillStyle = "rgba(155,176,201,.7)";
    ctx.font = "14px " + getComputedStyle(document.documentElement).getPropertyValue("--sans");
    ctx.textAlign = "center";
    ctx.fillText("Adicione ao menos 2 snapshots para ver o gr√°fico.", cssW/2, cssH/2);
    canvas.chartPoints = [];
    return;
  }

  const pad = 24;
  const W = cssW - pad*2;
  const H = cssH - pad*2;

  const values = history.map(x=>x.totalBRL);
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const range = (maxV - minV) || 1;

  // Grid
  ctx.strokeStyle = "rgba(155,176,201,.08)";
  ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){
    const y = pad + (H*(i/4));
    ctx.beginPath();
    ctx.moveTo(pad, y);
    ctx.lineTo(pad+W, y);
    ctx.stroke();
  }

  const first = values[0];
  const last = values[values.length-1];
  const up = last >= first;

  const gradient = ctx.createLinearGradient(0, pad, 0, pad+H);
  gradient.addColorStop(0, up ? "rgba(16,185,129,.25)" : "rgba(239,68,68,.25)");
  gradient.addColorStop(1, up ? "rgba(16,185,129,.05)" : "rgba(239,68,68,.05)");

  ctx.fillStyle = gradient;
  ctx.beginPath();
  history.forEach((p, i)=>{
    const x = pad + (W*(i/(history.length-1)));
    const y = pad + (H*(1 - ((p.totalBRL - minV)/range)));
    if(i===0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.lineTo(pad + W, pad + H);
  ctx.lineTo(pad, pad + H);
  ctx.closePath();
  ctx.fill();

  ctx.strokeStyle = up ? "#10b981" : "#ef4444";
  ctx.lineWidth = 3;
  ctx.beginPath();
  history.forEach((p, i)=>{
    const x = pad + (W*(i/(history.length-1)));
    const y = pad + (H*(1 - ((p.totalBRL - minV)/range)));
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  canvas.chartPoints = [];
  ctx.fillStyle = "#ffffff";
  ctx.strokeStyle = up ? "#10b981" : "#ef4444";
  ctx.lineWidth = 2.5;

  history.forEach((p, i)=>{
    const x = pad + (W*(i/(history.length-1)));
    const y = pad + (H*(1 - ((p.totalBRL - minV)/range)));
    
    canvas.chartPoints.push({ x, y, data: p });

    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
  });

  ctx.fillStyle = "rgba(155,176,201,.85)";
  ctx.font = "13px " + getComputedStyle(document.documentElement).getPropertyValue("--mono");
  ctx.textAlign = "left";
  ctx.fillText(history[0].date, pad, cssH - 8);
  ctx.textAlign = "right";
  ctx.fillText(history[history.length-1].date, pad + W, cssH - 8);

  ctx.textAlign = "left";
  ctx.fillText(fmtMoney(maxV,"BRL"), pad, 18);
  ctx.fillText(fmtMoney(minV,"BRL"), pad, cssH - pad - 8);
}

function drawAssetHistoryChart(history, asset){
  const canvas = el("assetHistoryChart");
  const ctx = canvas.getContext("2d");

  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const cssW = rect.width || 800;
  const cssH = rect.height || 300;

  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.scale(dpr, dpr);

  ctx.clearRect(0,0,cssW,cssH);

  if(!history || history.length<2){
    ctx.fillStyle = "rgba(155,176,201,.7)";
    ctx.font = "14px " + getComputedStyle(document.documentElement).getPropertyValue("--sans");
    ctx.textAlign = "center";
    ctx.fillText("Adicione ao menos 2 entradas para ver o gr√°fico.", cssW/2, cssH/2);
    canvas.chartPoints = [];
    return;
  }

  const pad = 24;
  const W = cssW - pad*2;
  const H = cssH - pad*2;

  const values = history.map(x=>x.valueBRL || 0);
  const minV = Math.min(...values);
  const maxV = Math.max(...values);
  const range = (maxV - minV) || 1;

  ctx.strokeStyle = "rgba(155,176,201,.08)";
  ctx.lineWidth = 1;
  for(let i=0;i<=4;i++){
    const y = pad + (H*(i/4));
    ctx.beginPath();
    ctx.moveTo(pad, y);
    ctx.lineTo(pad+W, y);
    ctx.stroke();
  }

  const first = values[0];
  const last = values[values.length-1];
  const up = last >= first;

  const gradient = ctx.createLinearGradient(0, pad, 0, pad+H);
  gradient.addColorStop(0, up ? "rgba(16,185,129,.25)" : "rgba(239,68,68,.25)");
  gradient.addColorStop(1, up ? "rgba(16,185,129,.05)" : "rgba(239,68,68,.05)");

  ctx.fillStyle = gradient;
  ctx.beginPath();
  history.forEach((p, i)=>{
    const x = pad + (W*(i/(history.length-1)));
    const y = pad + (H*(1 - ((p.valueBRL - minV)/range)));
    if(i===0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.lineTo(pad + W, pad + H);
  ctx.lineTo(pad, pad + H);
  ctx.closePath();
  ctx.fill();

  ctx.strokeStyle = up ? "#10b981" : "#ef4444";
  ctx.lineWidth = 3;
  ctx.beginPath();
  history.forEach((p, i)=>{
    const x = pad + (W*(i/(history.length-1)));
    const y = pad + (H*(1 - ((p.valueBRL - minV)/range)));
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  canvas.chartPoints = [];
  ctx.fillStyle = "#ffffff";
  ctx.strokeStyle = up ? "#10b981" : "#ef4444";
  ctx.lineWidth = 2.5;

  history.forEach((p, i)=>{
    const x = pad + (W*(i/(history.length-1)));
    const y = pad + (H*(1 - ((p.valueBRL - minV)/range)));
    
    canvas.chartPoints.push({ x, y, data: p });

    ctx.beginPath();
    ctx.arc(x, y, 5, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
  });

  ctx.fillStyle = "rgba(155,176,201,.85)";
  ctx.font = "13px " + getComputedStyle(document.documentElement).getPropertyValue("--mono");
  ctx.textAlign = "left";
  ctx.fillText(history[0].date, pad, cssH - 8);
  ctx.textAlign = "right";
  ctx.fillText(history[history.length-1].date, pad + W, cssH - 8);

  ctx.textAlign = "left";
  ctx.fillText(fmtMoney(maxV,"BRL"), pad, 18);
  ctx.fillText(fmtMoney(minV,"BRL"), pad, cssH - pad - 8);
}

function setupChartTooltip(canvasId, tooltipId){
  const canvas = el(canvasId);
  const tooltip = el(tooltipId);

  canvas.addEventListener('mousemove', (e)=>{
    if(!canvas.chartPoints || canvas.chartPoints.length === 0){
      tooltip.classList.remove('show');
      return;
    }

    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    let nearest = null;
    let minDist = 20;

    canvas.chartPoints.forEach(pt=>{
      const dist = Math.sqrt((pt.x - mouseX)**2 + (pt.y - mouseY)**2);
      if(dist < minDist){
        minDist = dist;
        nearest = pt;
      }
    });

    if(nearest){
      const data = nearest.data;
      let content = '';

      if(data.totalBRL !== undefined){
        // Portfolio history
        const allHistory = state.history;
        const idx = allHistory.indexOf(data);
        const prev = idx > 0 ? allHistory[idx - 1] : null;
        const delta = prev ? (data.totalBRL - prev.totalBRL) : null;
        const pct = (prev && prev.totalBRL>0) ? (delta/prev.totalBRL)*100 : null;

        content = `
          <div style="font-weight:700; margin-bottom:6px;">${data.date}</div>
          <div style="color:${delta>=0?'#10b981':'#ef4444'}; font-size:16px; font-weight:800; margin-bottom:4px;">
            ${fmtMoney(data.totalBRL, 'BRL')}
          </div>
          ${delta !== null ? `
            <div style="color:${delta>=0?'#10b981':'#ef4444'}; font-size:13px;">
              ${delta>=0?'‚ñ≤':'‚ñº'} ${fmtMoney(Math.abs(delta), 'BRL')} (${fmtPct(pct)})
            </div>
          ` : ''}
          ${data.note ? `<div style="margin-top:6px; color:var(--muted); font-size:11px;">${escapeHtml(data.note)}</div>` : ''}
        `;
      }else if(data.qty !== undefined){
        // Asset history
        content = `
          <div style="font-weight:700; margin-bottom:6px;">${data.date}</div>
          <div style="font-size:14px; margin-bottom:4px;">
            Qtd: <span style="font-weight:800">${fmtNum(data.qty, 8)}</span>
          </div>
          ${data.valueBRL ? `
            <div style="color:#10b981; font-size:16px; font-weight:800;">
              ${fmtMoney(data.valueBRL, 'BRL')}
            </div>
          ` : ''}
          ${data.note ? `<div style="margin-top:6px; color:var(--muted); font-size:11px;">${escapeHtml(data.note)}</div>` : ''}
        `;
      }

      tooltip.innerHTML = content;
      tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
      tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
      tooltip.classList.add('show');
    }else{
      tooltip.classList.remove('show');
    }
  });

  canvas.addEventListener('mouseleave', ()=>{
    tooltip.classList.remove('show');
  });
}

function renderHistory(){
  sortHistory();
  const h = getFilteredHistory();
  const tbody = el("historyTbody");
  tbody.innerHTML = "";

  if(state.history.length===0){
    el("historySummary").innerHTML = `<span class="muted">Nenhum snapshot ainda. Use "Salvar snapshot" no fim do m√™s.</span>`;
    drawHistoryChart([]);
    return;
  }

  if(h.length===0){
    el("historySummary").innerHTML = `<span class="muted">Nenhum snapshot no per√≠odo selecionado.</span>`;
    drawHistoryChart([]);
    return;
  }

  let first = h[0].totalBRL;
  let last = h[h.length-1].totalBRL;
  const growth = (first>0) ? ((last-first)/first)*100 : null;

  el("historySummary").innerHTML =
    `<b class="mono">${h.length}</b> registros ‚Ä¢ 
     Primeiro: <b class="mono">${h[0].date}</b> ‚Ä¢ 
     √öltimo: <b class="mono">${h[h.length-1].date}</b><br/>
     Crescimento: <b class="mono ${growth>=0?'pos':'neg'}">${fmtMoney(last-first,'BRL')}</b>
     ${growth!==null?`(<b class="mono ${growth>=0?'pos':'neg'}">${fmtPct(growth)}</b>)`:''} `;

  const recent = h.slice(-10).reverse();

  recent.forEach((cur, idx)=>{
    const actualIdx = h.length - 1 - idx;
    const prev = actualIdx > 0 ? h[actualIdx - 1] : null;
    const delta = prev ? (cur.totalBRL - prev.totalBRL) : null;
    const pct = (prev && prev.totalBRL>0) ? (delta/prev.totalBRL)*100 : null;

    const cls = delta===null ? "muted" : (delta>=0 ? "pos" : "neg");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div class="mono" style="font-weight:700; font-size:14px;">${cur.date}</div>
          ${cur.note?`<div class="muted" style="font-size:12px;">${escapeHtml(cur.note)}</div>`:""}
        </div>
      </td>
      <td class="right mono" style="font-weight:700; font-size:14px;">${fmtMoney(cur.totalBRL,'BRL')}</td>
      <td class="right mono ${cls}" style="font-weight:700">${delta===null?"‚Äî":fmtMoney(delta,'BRL')}</td>
      <td class="right mono ${cls}" style="font-weight:700">${pct===null?"‚Äî":fmtPct(pct)}</td>
    `;
    tbody.appendChild(tr);
  });

  drawHistoryChart(h);
}

function renderAssetHistory(){
  if(!currentViewAsset) return;

  const asset = currentViewAsset;
  sortAssetHistory(asset);
  const h = getFilteredAssetHistory(asset);
  const tbody = el("assetHistoryTbody");
  tbody.innerHTML = "";

  if(!asset.history || asset.history.length===0){
    el("assetHistorySummary").innerHTML = `<span class="muted">Nenhuma entrada ainda. Use "Adicionar entrada".</span>`;
    drawAssetHistoryChart([], asset);
    return;
  }

  if(h.length===0){
    el("assetHistorySummary").innerHTML = `<span class="muted">Nenhuma entrada no per√≠odo selecionado.</span>`;
    drawAssetHistoryChart([], asset);
    return;
  }

  let first = h[0].valueBRL || 0;
  let last = h[h.length-1].valueBRL || 0;
  const growth = (first>0) ? ((last-first)/first)*100 : null;

  el("assetHistorySummary").innerHTML =
    `<b class="mono">${h.length}</b> registros ‚Ä¢ 
     Primeiro: <b class="mono">${h[0].date}</b> ‚Ä¢ 
     √öltimo: <b class="mono">${h[h.length-1].date}</b><br/>
     ${growth!==null?`Varia√ß√£o: <b class="mono ${growth>=0?'pos':'neg'}">${fmtPct(growth)}</b>`:''} `;

  const recent = h.slice(-10).reverse();

  recent.forEach((cur, idx)=>{
    const actualIdx = h.length - 1 - idx;
    const prev = actualIdx > 0 ? h[actualIdx - 1] : null;
    const pct = (prev && prev.valueBRL>0 && cur.valueBRL) ? ((cur.valueBRL - prev.valueBRL)/prev.valueBRL)*100 : null;

    const cls = pct===null ? "muted" : (pct>=0 ? "pos" : "neg");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div class="mono" style="font-weight:700; font-size:14px;">${cur.date}</div>
          ${cur.note?`<div class="muted" style="font-size:12px;">${escapeHtml(cur.note)}</div>`:""}
        </div>
      </td>
      <td class="right mono" style="font-weight:700">${fmtNum(cur.qty, 8)}</td>
      <td class="right mono" style="font-weight:700; font-size:14px;">${cur.valueBRL ? fmtMoney(cur.valueBRL,'BRL') : '‚Äî'}</td>
      <td class="right mono ${cls}" style="font-weight:700">${pct===null?"‚Äî":fmtPct(pct)}</td>
    `;
    tbody.appendChild(tr);
  });

  drawAssetHistoryChart(h, asset);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Edit Asset Modal
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openEditModal(asset){
  currentEditAsset = asset;
  
  el("editAssetTitle").textContent = `Editar: ${asset.name}`;
  
  const qtyLabel = asset.mode === "manual_balance" ? "Saldo (valor total)" : "Quantidade";
  el("qtyLabel").textContent = qtyLabel;
  
  el("editQty").value = asset.qty || 0;
  el("editNotes").value = asset.notes || "";
  
  if(asset.mode === "manual_balance"){
    el("avgCostGroup").style.display = "none";
  }else{
    el("avgCostGroup").style.display = "block";
    el("editAvgCost").value = asset.avgCost || "";
  }
  
  if(asset.mode === "fund_manual"){
    el("manualPriceGroup").style.display = "block";
    el("editManualPrice").value = state.manualPrices[asset.id]?.price || 0;
  }else{
    el("manualPriceGroup").style.display = "none";
  }
  
  el("editAssetModal").classList.add("show");
}

function closeEditModal(){
  el("editAssetModal").classList.remove("show");
  currentEditAsset = null;
}

function saveEditAsset(){
  if(!currentEditAsset) return;
  
  const qty = Number(el("editQty").value);
  if(!Number.isFinite(qty)){
    toast("Quantidade inv√°lida.", 'error');
    return;
  }
  
  currentEditAsset.qty = qty;
  currentEditAsset.notes = el("editNotes").value || "";
  
  if(currentEditAsset.mode !== "manual_balance"){
    const avgCost = el("editAvgCost").value.trim();
    currentEditAsset.avgCost = avgCost === "" ? null : Number(avgCost);
  }
  
  if(currentEditAsset.mode === "fund_manual"){
    const manualPrice = Number(el("editManualPrice").value);
    if(Number.isFinite(manualPrice)){
      state.manualPrices[currentEditAsset.id] = { price: manualPrice };
    }
  }
  
  saveState();
  render();
  closeEditModal();
  toast("Ativo atualizado com sucesso.", 'success');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   View Asset History
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function viewAssetHistory(asset){
  currentViewAsset = asset;
  
  el("tabPortfolio").classList.remove("active");
  el("tabAsset").classList.add("active");
  el("tabAsset").style.display = "block";
  el("tabAsset").textContent = `üìà ${asset.name}`;
  
  el("historyMeta").textContent = `Hist√≥rico individual de ${asset.name}`;
  
  el("portfolioHistoryControls").style.display = "none";
  el("assetHistoryControls").style.display = "flex";
  
  el("portfolioHistoryView").style.display = "none";
  el("assetHistoryView").style.display = "grid";
  
  const qtyLabel = asset.mode === "manual_balance" ? "Saldo" : "Quantidade";
  el("assetHistoryQtyLabel").textContent = qtyLabel;
  
  renderAssetHistory();
}

function closeAssetHistory(){
  currentViewAsset = null;
  
  el("tabAsset").classList.remove("active");
  el("tabPortfolio").classList.add("active");
  el("tabAsset").style.display = "none";
  
  el("historyMeta").textContent = "Salve snapshots mensais e acompanhe crescimento";
  
  el("portfolioHistoryControls").style.display = "flex";
  el("assetHistoryControls").style.display = "none";
  
  el("portfolioHistoryView").style.display = "grid";
  el("assetHistoryView").style.display = "none";
  
  renderHistory();
}

function openAddAssetHistoryModal(){
  if(!currentViewAsset) return;
  
  const today = new Date().toISOString().slice(0,10);
  el("assetHistoryDate").value = today;
  el("assetHistoryQty").value = currentViewAsset.qty || 0;
  el("assetHistoryValue").value = "";
  el("assetHistoryNote").value = "";
  
  el("addAssetHistoryModal").classList.add("show");
}

function closeAddAssetHistoryModal(){
  el("addAssetHistoryModal").classList.remove("show");
}

function saveAssetHistoryEntry(){
  if(!currentViewAsset) return;
  
  const date = el("assetHistoryDate").value;
  const qty = Number(el("assetHistoryQty").value);
  const valueInput = el("assetHistoryValue").value.trim();
  const note = el("assetHistoryNote").value;
  
  let valueBRL = null;
  if(valueInput){
    valueBRL = Number(valueInput);
    if(!Number.isFinite(valueBRL)){
      toast("Valor inv√°lido.", 'error');
      return;
    }
  }else{
    // Calculate from current price
    const c = computeRow(currentViewAsset);
    if(c.valueBRL !== null){
      valueBRL = c.valueBRL;
    }
  }
  
  const ok = upsertAssetHistory(currentViewAsset, date, qty, valueBRL, note);
  if(ok){
    closeAddAssetHistoryModal();
    renderAssetHistory();
    toast("Entrada adicionada com sucesso.", 'success');
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Main Render
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateSystemStatus(){
  const dot = el("statusDot");
  const txt = el("statusText");

  const errors = [market.status.fx, market.status.btc, market.status.b3].filter(s=>s==='error').length;
  const warns = [market.status.fx, market.status.btc, market.status.b3].filter(s=>s==='warn').length;

  if(errors > 0){
    dot.className = "statusDot error";
    txt.textContent = `${errors} sistema${errors>1?'s':''} fora`;
  }else if(warns > 0){
    dot.className = "statusDot warn";
    txt.textContent = `Cache ativo`;
  }else{
    dot.className = "statusDot ok";
    txt.textContent = "Sistemas OK";
  }
}

function render(){
  el("fxUSDBRL").textContent = market.fx.USDBRL ? fmtNum(market.fx.USDBRL, 4) : "‚Äî";
  el("fxEURBRL").textContent = market.fx.EURBRL ? fmtNum(market.fx.EURBRL, 4) : "‚Äî";

  updateSystemStatus();

  const filter = (el("filterInput").value || "").trim().toLowerCase();
  const tbody = el("tbody");
  const mobileCards = el("mobileCards");
  tbody.innerHTML = "";
  mobileCards.innerHTML = "";

  let totalBRL = 0;
  let totalPnL = 0;
  let total24h = 0;
  let total24hBase = 0;

  const rows = state.assets.map(a=>{
    const c = computeRow(a);
    return { a, c };
  });

  rows.forEach(({a,c})=>{
    const key = `${a.name} ${a.symbol||""} ${a.account} ${a.category}`.toLowerCase();
    if(filter && !key.includes(filter)) return;

    if(c.valueBRL !== null && Number.isFinite(c.valueBRL)) totalBRL += c.valueBRL;
    if(c.pnlBRL !== null && Number.isFinite(c.pnlBRL)) totalPnL += c.pnlBRL;

    if(c.change !== null && c.valueBRL !== null && Number.isFinite(c.valueBRL)){
      total24h += c.valueBRL * (c.change/100);
      total24hBase += c.valueBRL;
    }

    const statusDot = (a.mode==="crypto" || a.mode==="stock_b3") ? "green" : (a.mode==="fund_manual" ? "yellow" : "blue");
    const statusText = (a.mode==="crypto" || a.mode==="stock_b3") ? "Autom√°tico" : (a.mode==="fund_manual" ? "Manual" : "Saldo manual");

    const qtyLabel = (a.mode==="manual_balance") ? "Saldo" : "Qtd";
    const qtyDisplay = (a.mode==="manual_balance") ? fmtMoney(Number(a.qty||0), a.currency) : fmtNum(Number(a.qty||0), 8);

    const priceDisplay = (c.price===null) ? "‚Äî" : (
      a.mode==="manual_balance" ? "‚Äî" :
      a.mode==="cash" ? fmtMoney(1, a.currency) :
      fmtMoney(c.price, a.currency)
    );

    const valueNativeDisplay = c.valueNative===null ? "‚Äî" : fmtMoney(c.valueNative, a.currency);
    const valueBRLDisplay = c.valueBRL===null ? "‚Äî" : fmtMoney(c.valueBRL, "BRL");

    const pnlClass = (c.pnlBRL===null) ? "muted" : (c.pnlBRL>=0 ? "pos" : "neg");
    const pnlDisplay = (c.pnlBRL===null) ? "‚Äî" : fmtMoney(c.pnlBRL, "BRL");

    const chgClass = (c.change===null) ? "muted" : (c.change>=0 ? "pos" : "neg");
    const chgDisplay = (c.change===null) ? "‚Äî" : fmtPct(c.change);

    // Table row
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <div style="font-weight:700; font-size:14px;">
            ${escapeHtml(a.name)} ${a.symbol?`<span class="muted mono" style="font-size:12px;">(${escapeHtml(a.symbol)})</span>`:""}
          </div>
          <div class="muted" style="font-size:13px;">
            <span class="mono">${escapeHtml(a.currency)}</span>
            ${a.notes ? ` ‚Ä¢ ${escapeHtml(a.notes)}` : ""}
          </div>
        </div>
      </td>
      <td class="muted" style="font-size:14px;">${escapeHtml(a.category)}</td>
      <td class="muted" style="font-size:14px;">${escapeHtml(a.account)}</td>
      <td class="right">
        <span class="muted" style="font-size:12px;">${qtyLabel}:</span>
        <span class="mono" style="font-weight:700; font-size:14px;">${qtyDisplay}</span>
      </td>
      <td class="right mono" style="font-weight:700; font-size:14px;">${priceDisplay}</td>
      <td class="right mono" style="font-weight:700; font-size:14px;">${valueNativeDisplay}</td>
      <td class="right mono" style="font-weight:800; font-size:15px;">${valueBRLDisplay}</td>
      <td class="right mono ${pnlClass}" style="font-weight:700; font-size:14px;">${pnlDisplay}</td>
      <td class="right mono ${chgClass}" style="font-weight:700; font-size:14px;">${chgDisplay}</td>
      <td>
        <span class="tag"><span class="dot ${statusDot}"></span>${statusText}</span>
      </td>
      <td>
        <button class="iconBtn edit-asset-btn" data-id="${a.id}" title="Editar ativo">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        </button>
      </td>
    `;
    tr.addEventListener('click', (e) => {
      if(!e.target.closest('.edit-asset-btn')){
        viewAssetHistory(a);
      }
    });
    tbody.appendChild(tr);

    // Mobile card
    const card = document.createElement("div");
    card.className = "assetCard";
    card.innerHTML = `
      <div class="cardRow">
        <div>
          <div style="font-weight:700; font-size:15px; margin-bottom:4px;">${escapeHtml(a.name)}</div>
          <div class="muted" style="font-size:12px;">${escapeHtml(a.category)} ‚Ä¢ ${escapeHtml(a.account)}</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="iconBtn edit-asset-btn-mobile" data-id="${a.id}" title="Editar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
          </button>
          <span class="tag"><span class="dot ${statusDot}"></span>${statusText}</span>
        </div>
      </div>
      <div class="cardRow">
        <span class="cardLabel">${qtyLabel}</span>
        <span class="cardValue">${qtyDisplay}</span>
      </div>
      <div class="cardRow">
        <span class="cardLabel">Pre√ßo Atual</span>
        <span class="cardValue">${priceDisplay}</span>
      </div>
      <div class="cardRow">
        <span class="cardLabel">Valor (BRL)</span>
        <span class="cardValue" style="color:#10b981; font-size:16px;">${valueBRLDisplay}</span>
      </div>
      <div class="cardRow">
        <span class="cardLabel">G/P</span>
        <span class="cardValue ${pnlClass}">${pnlDisplay}</span>
      </div>
      <div class="cardRow">
        <span class="cardLabel">24h</span>
        <span class="cardValue ${chgClass}">${chgDisplay}</span>
      </div>
    `;
    card.addEventListener('click', (e) => {
      if(!e.target.closest('.edit-asset-btn-mobile')){
        viewAssetHistory(a);
      }
    });
    mobileCards.appendChild(card);
  });

  // Add event listeners to edit buttons
  document.querySelectorAll('.edit-asset-btn, .edit-asset-btn-mobile').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = btn.dataset.id;
      const asset = state.assets.find(a => a.id === id);
      if(asset) openEditModal(asset);
    });
  });

  el("kpiTotalBRL").textContent = fmtMoney(totalBRL, "BRL");

  const pnlEl = el("kpiPnL");
  pnlEl.textContent = Number.isFinite(totalPnL) ? fmtMoney(totalPnL, "BRL") : "‚Äî";
  pnlEl.className = "value mono " + (totalPnL>0 ? "pos" : (totalPnL<0 ? "neg" : ""));

  const pct24h = (total24hBase>0) ? (total24h/total24hBase)*100 : null;
  const k24 = el("kpi24h");
  k24.textContent = (pct24h===null) ? "‚Äî" : `${fmtMoney(total24h,"BRL")} (${fmtPct(pct24h)})`;
  k24.className = "value mono " + (pct24h>0 ? "pos" : (pct24h<0 ? "neg" : ""));

  el("kpiTotalSub").textContent =
    `${state.assets.length} ativos ‚Ä¢ Base: BRL ‚Ä¢ Auto-refresh: ${state.settings.autoRefreshMinutes} min`;

  el("metaInfo").textContent =
    market.errors.length ? `‚ö†Ô∏è ${market.errors.join(" | ")}` :
    `Fontes: Frankfurter ‚Ä¢ CoinGecko ‚Ä¢ brapi.dev`;

  el("lastUpdated").textContent = market.lastUpdated ?
    new Date(market.lastUpdated).toLocaleString("pt-BR", {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }) : "‚Äî";

  if(currentViewAsset){
    renderAssetHistory();
  }else{
    renderHistory();
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Edit Modal (Bulk - Legacy)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function editQuantities(){
  for(const a of state.assets){
    const label = (a.mode==="manual_balance") ? "Saldo (valor total)" : "Quantidade";
    const v = prompt(`${a.name} (${a.account})\n${label} em ${a.currency}:`, String(a.qty ?? 0));
    if(v===null) return;
    const num = Number(v.replace(",", "."));
    if(!Number.isFinite(num)) { toast("Valor inv√°lido. Mantive o anterior.", 'error'); continue; }
    a.qty = num;

    if(a.mode!=="manual_balance"){
      const ac = prompt(`${a.name}\nPre√ßo m√©dio (opcional) em ${a.currency}.\nDeixe vazio para ignorar PnL.`, (a.avgCost ?? "")==="null" ? "" : String(a.avgCost ?? ""));
      if(ac===null) return;
      const trimmed = String(ac).trim();
      a.avgCost = trimmed==="" ? null : Number(trimmed.replace(",", "."));
      if(a.avgCost !== null && !Number.isFinite(a.avgCost)) a.avgCost = null;
    }

    if(a.mode==="fund_manual"){
      const p = prompt(`${a.name}\nPre√ßo por cota (manual) em EUR:`, String(state.manualPrices[a.id]?.price ?? 0));
      if(p===null) return;
      const pn = Number(String(p).replace(",", "."));
      if(Number.isFinite(pn)) state.manualPrices[a.id] = { price: pn };
    }
  }
  saveState();
  render();
  toast("Quantidades atualizadas com sucesso.", 'success');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Import/Export
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "invest_dashboard_data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("Dados exportados com sucesso.", 'success');
}

function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = async () => {
    const file = inp.files?.[0];
    if(!file) return;
    try{
      const txt = await file.text();
      const parsed = JSON.parse(txt);
      // Ensure all assets have history
      if(parsed.assets){
        parsed.assets.forEach(a => {
          if(!a.history) a.history = [];
        });
      }
      state = {
        ...structuredClone(DEFAULT_DATA),
        ...parsed,
        settings: { ...DEFAULT_DATA.settings, ...(parsed.settings||{}) },
        manualPrices: { ...DEFAULT_DATA.manualPrices, ...(parsed.manualPrices||{}) },
        history: Array.isArray(parsed.history) ? parsed.history : [],
        assets: parsed.assets || DEFAULT_DATA.assets
      };
      saveState();
      render();
      toast("Dados importados com sucesso.", 'success');
    }catch{
      toast("Falha ao importar JSON.", 'error');
    }
  };
  inp.click();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Refresh with Loading State
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function refreshAll(){
  const btn = el("refreshBtn");
  btn.disabled = true;
  btn.classList.add('loading');
  btn.textContent = "";

  market.errors = [];
  market.status = { fx: 'ok', btc: 'ok', b3: 'ok' };

  try{
    await Promise.all([
      fetchFX(),
      fetchCrypto(),
      fetchB3Quotes()
    ]);
  }catch(e){
    console.error("Refresh error:", e);
  }

  market.lastUpdated = Date.now();
  render();

  btn.disabled = false;
  btn.classList.remove('loading');
  btn.textContent = "Atualizar agora";
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Theme Toggle
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleTheme(){
  const current = document.body.getAttribute('data-theme') || 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', next);
  localStorage.setItem(THEME_KEY, next);
  
  setTimeout(()=>{
    if(currentViewAsset){
      renderAssetHistory();
    }else{
      renderHistory();
    }
  }, 100);
}

function loadTheme(){
  const saved = localStorage.getItem(THEME_KEY) || 'dark';
  document.body.setAttribute('data-theme', saved);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Event Listeners
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
el("refreshBtn").addEventListener("click", async ()=>{
  await refreshAll();
  toast("Dados atualizados.", 'success');
});

el("editBtn").addEventListener("click", editQuantities);
el("exportBtn").addEventListener("click", exportJSON);
el("importBtn").addEventListener("click", importJSON);

el("resetBtn").addEventListener("click", ()=>{
  const ok = confirm("‚ö†Ô∏è Tem certeza? Isso apaga TODOS os dados salvos (incluindo hist√≥rico).");
  if(!ok) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(CACHE_KEY);
  state = structuredClone(DEFAULT_DATA);
  cache = { fx: { data: null, expires: 0 }, btc: { data: null, expires: 0 }, b3: { data: null, expires: 0 } };
  saveState();
  render();
  toast("Dados resetados.", 'success');
});

el("filterInput").addEventListener("input", render);
el("themeToggle").addEventListener("click", toggleTheme);

// Compact view toggle
el("compactToggle").addEventListener("click", ()=>{
  isCompactView = !isCompactView;
  el("tableWrap").classList.toggle('compactView', isCompactView);
  el("compactToggle").textContent = isCompactView ? "üìä Modo tabela" : "üì± Modo compacto";
});

if(window.innerWidth <= 768){
  el("compactToggle").style.display = "inline-block";
}
window.addEventListener('resize', ()=>{
  if(window.innerWidth <= 768){
    el("compactToggle").style.display = "inline-block";
  }else{
    el("compactToggle").style.display = "none";
    isCompactView = false;
    el("tableWrap").classList.remove('compactView');
  }
});

// Portfolio History controls
const todayISO = new Date().toISOString().slice(0,10);
el("snapDate").value = todayISO;

el("saveSnapshotBtn").addEventListener("click", ()=>{
  const date = el("snapDate").value || todayISO;
  const note = el("snapNote").value || "";
  const total = computeTotalBRL();
  
  if(!Number.isFinite(total) || Number.isNaN(total)){
    toast("Total inv√°lido. Verifique os dados.", 'error');
    return;
  }

  const ok = upsertSnapshot(date, total, note);
  if(ok){
    toast("Snapshot salvo com sucesso.", 'success');
    el("snapNote").value = "";
    renderHistory();
  }
});

el("manageHistoryBtn").addEventListener("click", manageHistory);

el("deleteLastSnapshotBtn").addEventListener("click", ()=>{
  if(state.history.length===0){
    toast("N√£o h√° snapshots.", 'error');
    return;
  }
  const ok = confirm("‚ö†Ô∏è Apagar o √∫ltimo snapshot? N√£o √© poss√≠vel desfazer.");
  if(!ok) return;
  deleteLastSnapshot();
  renderHistory();
  toast("√öltimo snapshot apagado.", 'success');
});

// Portfolio range selector
document.querySelectorAll('.rangeBtn:not(.assetRangeBtn)').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.rangeBtn:not(.assetRangeBtn)').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    chartRange = btn.dataset.range;
    renderHistory();
  });
});

// Asset range selector
document.querySelectorAll('.assetRangeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.assetRangeBtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    assetChartRange = btn.dataset.range;
    renderAssetHistory();
  });
});

// History tabs
el("tabPortfolio").addEventListener("click", closeAssetHistory);
el("tabAsset").addEventListener("click", ()=>{
  if(currentViewAsset){
    renderAssetHistory();
  }
});

// Asset history controls
el("closeAssetHistoryBtn").addEventListener("click", closeAssetHistory);
el("addAssetHistoryBtn").addEventListener("click", openAddAssetHistoryModal);
el("manageAssetHistoryBtn").addEventListener("click", ()=>{
  if(currentViewAsset) manageAssetHistory(currentViewAsset);
});

// Edit asset modal
el("closeEditModal").addEventListener("click", closeEditModal);
el("cancelEditBtn").addEventListener("click", closeEditModal);
el("saveEditBtn").addEventListener("click", saveEditAsset);

// Asset history modal
el("closeAssetHistoryModal").addEventListener("click", closeAddAssetHistoryModal);
el("cancelAssetHistoryBtn").addEventListener("click", closeAddAssetHistoryModal);
el("saveAssetHistoryBtn").addEventListener("click", saveAssetHistoryEntry);

// Close modals on outside click
el("editAssetModal").addEventListener("click", (e)=>{
  if(e.target === el("editAssetModal")) closeEditModal();
});
el("addAssetHistoryModal").addEventListener("click", (e)=>{
  if(e.target === el("addAssetHistoryModal")) closeAddAssetHistoryModal();
});

// Chart resize
window.addEventListener('resize', ()=>{
  if(currentViewAsset){
    setTimeout(()=>renderAssetHistory(), 100);
  }else if(state.history.length > 0){
    setTimeout(()=>renderHistory(), 100);
  }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Bootstrap
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
loadTheme();
loadCache();
render();
setupChartTooltip('historyChart', 'chartTooltip');
setupChartTooltip('assetHistoryChart', 'assetChartTooltip');
refreshAll();

// Auto-refresh
setInterval(refreshAll, Math.max(5, Number(state.settings.autoRefreshMinutes||30)) * 60 * 1000);
</script>
</body>
</html>
